
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>PERLGUTS</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css" href="/global/main.css" title="default">
</head>

<body>



<div id="container">


<div id="content">

<div id='catHeader'><table width='100%'><tr><td>
<H1>PERLGUTS</H1>
Section: Perl Programmers Reference Guide (1)<BR>Updated: 2004-04-23<BR>
</td><td align='right' valign='bottom'><div class='ad_header_right'></div></td></tr></table></div></div>
<div id='categories'>
<div class='ad_man_right'>
</div>

<A NAME="lbAB">&nbsp;</A>
<H2>NAME</H2>

perlguts - Introduction to the Perl API
<A NAME="lbAC">&nbsp;</A>
<H2>DESCRIPTION</H2>

<A NAME="ixAAC"></A>
This document attempts to describe how to use the Perl <FONT SIZE="-1">API</FONT>, as well as
to provide some info on the basic workings of the Perl core. It is far
from complete and probably contains many errors. Please refer any
questions or comments to the author below.
<A NAME="lbAD">&nbsp;</A>
<H2>Variables</H2>

<A NAME="ixAAD"></A>
<A NAME="lbAE">&nbsp;</A>
<H2>Datatypes</H2>

<A NAME="ixAAE"></A>
Perl has three typedefs that handle Perl's three main data types:
<P>



<PRE>
    SV  Scalar Value
    AV  Array Value
    HV  Hash Value

</PRE>


<P>

Each typedef has specific routines that manipulate the various data types.
<A NAME="lbAF">&nbsp;</A>
<H2>What is an <FONT SIZE="-1">IV</FONT>?</H2>



<A NAME="ixAAF"></A>
Perl uses a special typedef <FONT SIZE="-1">IV</FONT> which is a simple signed integer type that is
guaranteed to be large enough to hold a pointer (as well as an integer).
Additionally, there is the <FONT SIZE="-1">UV</FONT>, which is simply an unsigned <FONT SIZE="-1">IV</FONT>.
<P>

Perl also uses two special typedefs, I32 and I16, which will always be at
least 32-bits and 16-bits long, respectively. (Again, there are U32 and U16,
as well.)  They will usually be exactly 32 and 16 bits long, but on Crays
they will both be 64 bits.
<A NAME="lbAG">&nbsp;</A>
<H2>Working with SVs</H2>

<A NAME="ixAAG"></A>
An <FONT SIZE="-1">SV</FONT> can be created and loaded with one command.  There are five types of
values that can be loaded: an integer value (<FONT SIZE="-1">IV</FONT>), an unsigned integer
value (<FONT SIZE="-1">UV</FONT>), a double (<FONT SIZE="-1">NV</FONT>), a string (<FONT SIZE="-1">PV</FONT>), and another scalar (<FONT SIZE="-1">SV</FONT>).
<P>

The seven routines are:
<P>



<PRE>
    SV*  newSViv(IV);
    SV*  newSVuv(UV);
    SV*  newSVnv(double);
    SV*  newSVpv(const char*, STRLEN);
    SV*  newSVpvn(const char*, STRLEN);
    SV*  newSVpvf(const char*, ...);
    SV*  newSVsv(SV*);

</PRE>


<P>

<TT>&quot;STRLEN&quot;</TT> is an integer type (Size_t, usually defined as size_t in
<I>config.h</I>) guaranteed to be large enough to represent the size of
any string that perl can handle.
<P>

In the unlikely case of a <FONT SIZE="-1">SV</FONT> requiring more complex initialisation, you
can create an empty <FONT SIZE="-1">SV</FONT> with newSV(len).  If <TT>&quot;len&quot;</TT> is 0 an empty <FONT SIZE="-1">SV</FONT> of
type <FONT SIZE="-1">NULL</FONT> is returned, else an <FONT SIZE="-1">SV</FONT> of type <FONT SIZE="-1">PV</FONT> is returned with len + 1 (for
the <FONT SIZE="-1">NUL</FONT>) bytes of storage allocated, accessible via SvPVX.  In both cases
the <FONT SIZE="-1">SV</FONT> has value undef.
<P>



<PRE>
    SV *sv = newSV(0);   /* no storage allocated  */
    SV *sv = newSV(10);  /* 10 (+1) bytes of uninitialised storage allocated  */

</PRE>


<P>

To change the value of an <I>already-existing</I> <FONT SIZE="-1">SV</FONT>, there are eight routines:
<P>



<PRE>
    void  sv_setiv(SV*, IV);
    void  sv_setuv(SV*, UV);
    void  sv_setnv(SV*, double);
    void  sv_setpv(SV*, const char*);
    void  sv_setpvn(SV*, const char*, STRLEN)
    void  sv_setpvf(SV*, const char*, ...);
    void  sv_vsetpvfn(SV*, const char*, STRLEN, va_list *, SV **, I32, bool *);
    void  sv_setsv(SV*, SV*);

</PRE>


<P>

Notice that you can choose to specify the length of the string to be
assigned by using <TT>&quot;sv_setpvn&quot;</TT>, <TT>&quot;newSVpvn&quot;</TT>, or <TT>&quot;newSVpv&quot;</TT>, or you may
allow Perl to calculate the length by using <TT>&quot;sv_setpv&quot;</TT> or by specifying
0 as the second argument to <TT>&quot;newSVpv&quot;</TT>.  Be warned, though, that Perl will
determine the string's length by using <TT>&quot;strlen&quot;</TT>, which depends on the
string terminating with a <FONT SIZE="-1">NUL</FONT> character.
<P>

The arguments of <TT>&quot;sv_setpvf&quot;</TT> are processed like <TT>&quot;sprintf&quot;</TT>, and the
formatted output becomes the value.
<P>

<TT>&quot;sv_vsetpvfn&quot;</TT> is an analogue of <TT>&quot;vsprintf&quot;</TT>, but it allows you to specify
either a pointer to a variable argument list or the address and length of
an array of SVs.  The last argument points to a boolean; on return, if that
boolean is true, then locale-specific information has been used to format
the string, and the string's contents are therefore untrustworthy (see
perlsec).  This pointer may be <FONT SIZE="-1">NULL</FONT> if that information is not
important.  Note that this function requires you to specify the length of
the format.
<P>

The <TT>&quot;sv_set*()&quot;</TT> functions are not generic enough to operate on values
that have ``magic''.  See ``Magic Virtual Tables'' later in this document.
<P>

All SVs that contain strings should be terminated with a <FONT SIZE="-1">NUL</FONT> character.
If it is not NUL-terminated there is a risk of
core dumps and corruptions from code which passes the string to C
functions or system calls which expect a NUL-terminated string.
Perl's own functions typically add a trailing <FONT SIZE="-1">NUL</FONT> for this reason.
Nevertheless, you should be very careful when you pass a string stored
in an <FONT SIZE="-1">SV</FONT> to a C function or system call.
<P>

To access the actual value that an <FONT SIZE="-1">SV</FONT> points to, you can use the macros:
<P>



<PRE>
    SvIV(SV*)
    SvUV(SV*)
    SvNV(SV*)
    SvPV(SV*, STRLEN len)
    SvPV_nolen(SV*)

</PRE>


<P>

which will automatically coerce the actual scalar type into an <FONT SIZE="-1">IV</FONT>, <FONT SIZE="-1">UV</FONT>, double,
or string.
<P>

In the <TT>&quot;SvPV&quot;</TT> macro, the length of the string returned is placed into the
variable <TT>&quot;len&quot;</TT> (this is a macro, so you do <I>not</I> use <TT>&amp;len</TT>).  If you do
not care what the length of the data is, use the <TT>&quot;SvPV_nolen&quot;</TT> macro.
Historically the <TT>&quot;SvPV&quot;</TT> macro with the global variable <TT>&quot;PL_na&quot;</TT> has been
used in this case.  But that can be quite inefficient because <TT>&quot;PL_na&quot;</TT> must
be accessed in thread-local storage in threaded Perl.  In any case, remember
that Perl allows arbitrary strings of data that may both contain NULs and
might not be terminated by a <FONT SIZE="-1">NUL</FONT>.
<P>

Also remember that C doesn't allow you to safely say <TT>&quot;foo(SvPV(s, len),
len);&quot;</TT>. It might work with your compiler, but it won't work for everyone.
Break this sort of statement up into separate assignments:
<P>



<PRE>
        SV *s;
        STRLEN len;
        char * ptr;
        ptr = SvPV(s, len);
        foo(ptr, len);

</PRE>


<P>

If you want to know if the scalar value is <FONT SIZE="-1">TRUE</FONT>, you can use:
<P>



<PRE>
    SvTRUE(SV*)

</PRE>


<P>

Although Perl will automatically grow strings for you, if you need to force
Perl to allocate more memory for your <FONT SIZE="-1">SV</FONT>, you can use the macro
<P>



<PRE>
    SvGROW(SV*, STRLEN newlen)

</PRE>


<P>

which will determine if more memory needs to be allocated.  If so, it will
call the function <TT>&quot;sv_grow&quot;</TT>.  Note that <TT>&quot;SvGROW&quot;</TT> can only increase, not
decrease, the allocated memory of an <FONT SIZE="-1">SV</FONT> and that it does not automatically
add a byte for the a trailing <FONT SIZE="-1">NUL</FONT> (perl's own string functions typically do
<TT>&quot;SvGROW(sv, len + 1)&quot;</TT>).
<P>

If you have an <FONT SIZE="-1">SV</FONT> and want to know what kind of data Perl thinks is stored
in it, you can use the following macros to check the type of <FONT SIZE="-1">SV</FONT> you have.
<P>



<PRE>
    SvIOK(SV*)
    SvNOK(SV*)
    SvPOK(SV*)

</PRE>


<P>

You can get and set the current length of the string stored in an <FONT SIZE="-1">SV</FONT> with
the following macros:
<P>



<PRE>
    SvCUR(SV*)
    SvCUR_set(SV*, I32 val)

</PRE>


<P>

You can also get a pointer to the end of the string stored in the <FONT SIZE="-1">SV</FONT>
with the macro:
<P>



<PRE>
    SvEND(SV*)

</PRE>


<P>

But note that these last three macros are valid only if <TT>&quot;SvPOK()&quot;</TT> is true.
<P>

If you want to append something to the end of string stored in an <TT>&quot;SV*&quot;</TT>,
you can use the following functions:
<P>



<PRE>
    void  sv_catpv(SV*, const char*);
    void  sv_catpvn(SV*, const char*, STRLEN);
    void  sv_catpvf(SV*, const char*, ...);
    void  sv_vcatpvfn(SV*, const char*, STRLEN, va_list *, SV **, I32, bool);
    void  sv_catsv(SV*, SV*);

</PRE>


<P>

The first function calculates the length of the string to be appended by
using <TT>&quot;strlen&quot;</TT>.  In the second, you specify the length of the string
yourself.  The third function processes its arguments like <TT>&quot;sprintf&quot;</TT> and
appends the formatted output.  The fourth function works like <TT>&quot;vsprintf&quot;</TT>.
You can specify the address and length of an array of SVs instead of the
va_list argument. The fifth function extends the string stored in the first
<FONT SIZE="-1">SV</FONT> with the string stored in the second <FONT SIZE="-1">SV</FONT>.  It also forces the second <FONT SIZE="-1">SV</FONT>
to be interpreted as a string.
<P>

The <TT>&quot;sv_cat*()&quot;</TT> functions are not generic enough to operate on values that
have ``magic''.  See ``Magic Virtual Tables'' later in this document.
<P>

If you know the name of a scalar variable, you can get a pointer to its <FONT SIZE="-1">SV</FONT>
by using the following:
<P>



<PRE>
    SV*  get_sv(&quot;package::varname&quot;, FALSE);

</PRE>


<P>

This returns <FONT SIZE="-1">NULL</FONT> if the variable does not exist.
<P>

If you want to know if this variable (or any other <FONT SIZE="-1">SV</FONT>) is actually <TT>&quot;defined&quot;</TT>,
you can call:
<P>



<PRE>
    SvOK(SV*)

</PRE>


<P>

The scalar <TT>&quot;undef&quot;</TT> value is stored in an <FONT SIZE="-1">SV</FONT> instance called <TT>&quot;PL_sv_undef&quot;</TT>.
<P>

Its address can be used whenever an <TT>&quot;SV*&quot;</TT> is needed. Make sure that
you don't try to compare a random sv with <TT>&amp;PL_sv_undef</TT>. For example
when interfacing Perl code, it'll work correctly for:
<P>



<PRE>
  foo(undef);

</PRE>


<P>

But won't work when called as:
<P>



<PRE>
  $x = undef;
  foo($x);

</PRE>


<P>

So to repeat always use <I>SvOK()</I> to check whether an sv is defined.
<P>

Also you have to be careful when using <TT>&amp;PL_sv_undef</TT> as a value in
AVs or HVs (see ``AVs, HVs and undefined values'').
<P>

There are also the two values <TT>&quot;PL_sv_yes&quot;</TT> and <TT>&quot;PL_sv_no&quot;</TT>, which contain
boolean <FONT SIZE="-1">TRUE</FONT> and <FONT SIZE="-1">FALSE</FONT> values, respectively.  Like <TT>&quot;PL_sv_undef&quot;</TT>, their
addresses can be used whenever an <TT>&quot;SV*&quot;</TT> is needed.
<P>

Do not be fooled into thinking that <TT>&quot;(SV *) 0&quot;</TT> is the same as <TT>&amp;PL_sv_undef</TT>.
Take this code:
<P>



<PRE>
    SV* sv = (SV*) 0;
    if (I-am-to-return-a-real-value) {
            sv = sv_2mortal(newSViv(42));
    }
    sv_setsv(ST(0), sv);

</PRE>


<P>

This code tries to return a new <FONT SIZE="-1">SV</FONT> (which contains the value 42) if it should
return a real value, or undef otherwise.  Instead it has returned a <FONT SIZE="-1">NULL</FONT>
pointer which, somewhere down the line, will cause a segmentation violation,
bus error, or just weird results.  Change the zero to <TT>&amp;PL_sv_undef</TT> in the
first line and all will be well.
<P>

To free an <FONT SIZE="-1">SV</FONT> that you've created, call <TT>&quot;SvREFCNT_dec(SV*)&quot;</TT>.  Normally this
call is not necessary (see ``Reference Counts and Mortality'').
<A NAME="lbAH">&nbsp;</A>
<H2>Offsets</H2>

<A NAME="ixAAH"></A>
Perl provides the function <TT>&quot;sv_chop&quot;</TT> to efficiently remove characters
from the beginning of a string; you give it an <FONT SIZE="-1">SV</FONT> and a pointer to
somewhere inside the <FONT SIZE="-1">PV</FONT>, and it discards everything before the
pointer. The efficiency comes by means of a little hack: instead of
actually removing the characters, <TT>&quot;sv_chop&quot;</TT> sets the flag <TT>&quot;OOK&quot;</TT>
(offset <FONT SIZE="-1">OK</FONT>) to signal to other functions that the offset hack is in
effect, and it puts the number of bytes chopped off into the <FONT SIZE="-1">IV</FONT> field
of the <FONT SIZE="-1">SV</FONT>. It then moves the <FONT SIZE="-1">PV</FONT> pointer (called <TT>&quot;SvPVX&quot;</TT>) forward that
many bytes, and adjusts <TT>&quot;SvCUR&quot;</TT> and <TT>&quot;SvLEN&quot;</TT>.
<P>

Hence, at this point, the start of the buffer that we allocated lives
at <TT>&quot;SvPVX(sv) - SvIV(sv)&quot;</TT> in memory and the <FONT SIZE="-1">PV</FONT> pointer is pointing
into the middle of this allocated storage.
<P>

This is best demonstrated by example:
<P>



<PRE>
  % ./perl -Ilib -MDevel::Peek -le '$a=&quot;12345&quot;; $a=~s/.//; Dump($a)'
  SV = PVIV(0x8128450) at 0x81340f0
    REFCNT = 1
    FLAGS = (POK,OOK,pPOK)
    IV = 1  (OFFSET)
    PV = 0x8135781 ( &quot;1&quot; . ) &quot;2345&quot;\0
    CUR = 4
    LEN = 5

</PRE>


<P>

Here the number of bytes chopped off (1) is put into <FONT SIZE="-1">IV</FONT>, and
<TT>&quot;Devel::Peek::Dump&quot;</TT> helpfully reminds us that this is an offset. The
portion of the string between the ``real'' and the ``fake'' beginnings is
shown in parentheses, and the values of <TT>&quot;SvCUR&quot;</TT> and <TT>&quot;SvLEN&quot;</TT> reflect
the fake beginning, not the real one.
<P>

Something similar to the offset hack is performed on AVs to enable
efficient shifting and splicing off the beginning of the array; while
<TT>&quot;AvARRAY&quot;</TT> points to the first element in the array that is visible from
Perl, <TT>&quot;AvALLOC&quot;</TT> points to the real start of the C array. These are
usually the same, but a <TT>&quot;shift&quot;</TT> operation can be carried out by
increasing <TT>&quot;AvARRAY&quot;</TT> by one and decreasing <TT>&quot;AvFILL&quot;</TT> and <TT>&quot;AvLEN&quot;</TT>.
Again, the location of the real start of the C array only comes into
play when freeing the array. See <TT>&quot;av_shift&quot;</TT> in <I>av.c</I>.
<A NAME="lbAI">&nbsp;</A>
<H2>What's Really Stored in an <FONT SIZE="-1">SV</FONT>?</H2>

<A NAME="ixAAI"></A>
Recall that the usual method of determining the type of scalar you have is
to use <TT>&quot;Sv*OK&quot;</TT> macros.  Because a scalar can be both a number and a string,
usually these macros will always return <FONT SIZE="-1">TRUE</FONT> and calling the <TT>&quot;Sv*V&quot;</TT>
macros will do the appropriate conversion of string to integer/double or
integer/double to string.
<P>

If you <I>really</I> need to know if you have an integer, double, or string
pointer in an <FONT SIZE="-1">SV</FONT>, you can use the following three macros instead:
<P>



<PRE>
    SvIOKp(SV*)
    SvNOKp(SV*)
    SvPOKp(SV*)

</PRE>


<P>

These will tell you if you truly have an integer, double, or string pointer
stored in your <FONT SIZE="-1">SV</FONT>.  The ``p'' stands for private.
<P>

The are various ways in which the private and public flags may differ.
For example, a tied <FONT SIZE="-1">SV</FONT> may have a valid underlying value in the <FONT SIZE="-1">IV</FONT> slot
(so SvIOKp is true), but the data should be accessed via the <FONT SIZE="-1">FETCH</FONT>
routine rather than directly, so SvIOK is false. Another is when
numeric conversion has occured and precision has been lost: only the
private flag is set on 'lossy' values. So when an <FONT SIZE="-1">NV</FONT> is converted to an
<FONT SIZE="-1">IV</FONT> with loss, SvIOKp, SvNOKp and SvNOK will be set, while SvIOK wont be.
<P>

In general, though, it's best to use the <TT>&quot;Sv*V&quot;</TT> macros.
<A NAME="lbAJ">&nbsp;</A>
<H2>Working with AVs</H2>

<A NAME="ixAAJ"></A>
There are two ways to create and load an <FONT SIZE="-1">AV</FONT>.  The first method creates an
empty <FONT SIZE="-1">AV:</FONT>
<P>



<PRE>
    AV*  newAV();

</PRE>


<P>

The second method both creates the <FONT SIZE="-1">AV</FONT> and initially populates it with SVs:
<P>



<PRE>
    AV*  av_make(I32 num, SV **ptr);

</PRE>


<P>

The second argument points to an array containing <TT>&quot;num&quot;</TT> <TT>&quot;SV*&quot;</TT>'s.  Once the
<FONT SIZE="-1">AV</FONT> has been created, the SVs can be destroyed, if so desired.
<P>

Once the <FONT SIZE="-1">AV</FONT> has been created, the following operations are possible on AVs:
<P>



<PRE>
    void  av_push(AV*, SV*);
    SV*   av_pop(AV*);
    SV*   av_shift(AV*);
    void  av_unshift(AV*, I32 num);

</PRE>


<P>

These should be familiar operations, with the exception of <TT>&quot;av_unshift&quot;</TT>.
This routine adds <TT>&quot;num&quot;</TT> elements at the front of the array with the <TT>&quot;undef&quot;</TT>
value.  You must then use <TT>&quot;av_store&quot;</TT> (described below) to assign values
to these new elements.
<P>

Here are some other functions:
<P>



<PRE>
    I32   av_len(AV*);
    SV**  av_fetch(AV*, I32 key, I32 lval);
    SV**  av_store(AV*, I32 key, SV* val);

</PRE>


<P>

The <TT>&quot;av_len&quot;</TT> function returns the highest index value in array (just
like $#array in Perl).  If the array is empty, -1 is returned.  The
<TT>&quot;av_fetch&quot;</TT> function returns the value at index <TT>&quot;key&quot;</TT>, but if <TT>&quot;lval&quot;</TT>
is non-zero, then <TT>&quot;av_fetch&quot;</TT> will store an undef value at that index.
The <TT>&quot;av_store&quot;</TT> function stores the value <TT>&quot;val&quot;</TT> at index <TT>&quot;key&quot;</TT>, and does
not increment the reference count of <TT>&quot;val&quot;</TT>.  Thus the caller is responsible
for taking care of that, and if <TT>&quot;av_store&quot;</TT> returns <FONT SIZE="-1">NULL</FONT>, the caller will
have to decrement the reference count to avoid a memory leak.  Note that
<TT>&quot;av_fetch&quot;</TT> and <TT>&quot;av_store&quot;</TT> both return <TT>&quot;SV**&quot;</TT>'s, not <TT>&quot;SV*&quot;</TT>'s as their
return value.
<P>



<PRE>
    void  av_clear(AV*);
    void  av_undef(AV*);
    void  av_extend(AV*, I32 key);

</PRE>


<P>

The <TT>&quot;av_clear&quot;</TT> function deletes all the elements in the AV* array, but
does not actually delete the array itself.  The <TT>&quot;av_undef&quot;</TT> function will
delete all the elements in the array plus the array itself.  The
<TT>&quot;av_extend&quot;</TT> function extends the array so that it contains at least <TT>&quot;key+1&quot;</TT>
elements.  If <TT>&quot;key+1&quot;</TT> is less than the currently allocated length of the array,
then nothing is done.
<P>

If you know the name of an array variable, you can get a pointer to its <FONT SIZE="-1">AV</FONT>
by using the following:
<P>



<PRE>
    AV*  get_av(&quot;package::varname&quot;, FALSE);

</PRE>


<P>

This returns <FONT SIZE="-1">NULL</FONT> if the variable does not exist.
<P>

See ``Understanding the Magic of Tied Hashes and Arrays'' for more
information on how to use the array access functions on tied arrays.
<A NAME="lbAK">&nbsp;</A>
<H2>Working with HVs</H2>

<A NAME="ixAAK"></A>
To create an <FONT SIZE="-1">HV</FONT>, you use the following routine:
<P>



<PRE>
    HV*  newHV();

</PRE>


<P>

Once the <FONT SIZE="-1">HV</FONT> has been created, the following operations are possible on HVs:
<P>



<PRE>
    SV**  hv_store(HV*, const char* key, U32 klen, SV* val, U32 hash);
    SV**  hv_fetch(HV*, const char* key, U32 klen, I32 lval);

</PRE>


<P>

The <TT>&quot;klen&quot;</TT> parameter is the length of the key being passed in (Note that
you cannot pass 0 in as a value of <TT>&quot;klen&quot;</TT> to tell Perl to measure the
length of the key).  The <TT>&quot;val&quot;</TT> argument contains the <FONT SIZE="-1">SV</FONT> pointer to the
scalar being stored, and <TT>&quot;hash&quot;</TT> is the precomputed hash value (zero if
you want <TT>&quot;hv_store&quot;</TT> to calculate it for you).  The <TT>&quot;lval&quot;</TT> parameter
indicates whether this fetch is actually a part of a store operation, in
which case a new undefined value will be added to the <FONT SIZE="-1">HV</FONT> with the supplied
key and <TT>&quot;hv_fetch&quot;</TT> will return as if the value had already existed.
<P>

Remember that <TT>&quot;hv_store&quot;</TT> and <TT>&quot;hv_fetch&quot;</TT> return <TT>&quot;SV**&quot;</TT>'s and not just
<TT>&quot;SV*&quot;</TT>.  To access the scalar value, you must first dereference the return
value.  However, you should check to make sure that the return value is
not <FONT SIZE="-1">NULL</FONT> before dereferencing it.
<P>

These two functions check if a hash table entry exists, and deletes it.
<P>



<PRE>
    bool  hv_exists(HV*, const char* key, U32 klen);
    SV*   hv_delete(HV*, const char* key, U32 klen, I32 flags);

</PRE>


<P>

If <TT>&quot;flags&quot;</TT> does not include the <TT>&quot;G_DISCARD&quot;</TT> flag then <TT>&quot;hv_delete&quot;</TT> will
create and return a mortal copy of the deleted value.
<P>

And more miscellaneous functions:
<P>



<PRE>
    void   hv_clear(HV*);
    void   hv_undef(HV*);

</PRE>


<P>

Like their <FONT SIZE="-1">AV</FONT> counterparts, <TT>&quot;hv_clear&quot;</TT> deletes all the entries in the hash
table but does not actually delete the hash table.  The <TT>&quot;hv_undef&quot;</TT> deletes
both the entries and the hash table itself.
<P>

Perl keeps the actual data in linked list of structures with a typedef of <FONT SIZE="-1">HE</FONT>.
These contain the actual key and value pointers (plus extra administrative
overhead).  The key is a string pointer; the value is an <TT>&quot;SV*&quot;</TT>.  However,
once you have an <TT>&quot;HE*&quot;</TT>, to get the actual key and value, use the routines
specified below.
<P>



<PRE>
    I32    hv_iterinit(HV*);
            /* Prepares starting point to traverse hash table */
    HE*    hv_iternext(HV*);
            /* Get the next entry, and return a pointer to a
               structure that has both the key and value */
    char*  hv_iterkey(HE* entry, I32* retlen);
            /* Get the key from an HE structure and also return
               the length of the key string */
    SV*    hv_iterval(HV*, HE* entry);
            /* Return an SV pointer to the value of the HE
               structure */
    SV*    hv_iternextsv(HV*, char** key, I32* retlen);
            /* This convenience routine combines hv_iternext,
               hv_iterkey, and hv_iterval.  The key and retlen
               arguments are return values for the key and its
               length.  The value is returned in the SV* argument */

</PRE>


<P>

If you know the name of a hash variable, you can get a pointer to its <FONT SIZE="-1">HV</FONT>
by using the following:
<P>



<PRE>
    HV*  get_hv(&quot;package::varname&quot;, FALSE);

</PRE>


<P>

This returns <FONT SIZE="-1">NULL</FONT> if the variable does not exist.
<P>

The hash algorithm is defined in the <TT>&quot;PERL_HASH(hash, key, klen)&quot;</TT> macro:
<P>



<PRE>
    hash = 0;
    while (klen--)
        hash = (hash * 33) + *key++;
    hash = hash + (hash &gt;&gt; 5);                  /* after 5.6 */

</PRE>


<P>

The last step was added in version 5.6 to improve distribution of
lower bits in the resulting hash value.
<P>

See ``Understanding the Magic of Tied Hashes and Arrays'' for more
information on how to use the hash access functions on tied hashes.
<A NAME="lbAL">&nbsp;</A>
<H2>Hash <FONT SIZE="-1">API</FONT> Extensions</H2>

<A NAME="ixAAL"></A>
Beginning with version 5.004, the following functions are also supported:
<P>



<PRE>
    HE*     hv_fetch_ent  (HV* tb, SV* key, I32 lval, U32 hash);
    HE*     hv_store_ent  (HV* tb, SV* key, SV* val, U32 hash);

</PRE>


<P>



<PRE>
    bool    hv_exists_ent (HV* tb, SV* key, U32 hash);
    SV*     hv_delete_ent (HV* tb, SV* key, I32 flags, U32 hash);

</PRE>


<P>



<PRE>
    SV*     hv_iterkeysv  (HE* entry);

</PRE>


<P>

Note that these functions take <TT>&quot;SV*&quot;</TT> keys, which simplifies writing
of extension code that deals with hash structures.  These functions
also allow passing of <TT>&quot;SV*&quot;</TT> keys to <TT>&quot;tie&quot;</TT> functions without forcing
you to stringify the keys (unlike the previous set of functions).
<P>

They also return and accept whole hash entries (<TT>&quot;HE*&quot;</TT>), making their
use more efficient (since the hash number for a particular string
doesn't have to be recomputed every time).  See perlapi for detailed
descriptions.
<P>

The following macros must always be used to access the contents of hash
entries.  Note that the arguments to these macros must be simple
variables, since they may get evaluated more than once.  See
perlapi for detailed descriptions of these macros.
<P>



<PRE>
    HePV(HE* he, STRLEN len)
    HeVAL(HE* he)
    HeHASH(HE* he)
    HeSVKEY(HE* he)
    HeSVKEY_force(HE* he)
    HeSVKEY_set(HE* he, SV* sv)

</PRE>


<P>

These two lower level macros are defined, but must only be used when
dealing with keys that are not <TT>&quot;SV*&quot;</TT>s:
<P>



<PRE>
    HeKEY(HE* he)
    HeKLEN(HE* he)

</PRE>


<P>

Note that both <TT>&quot;hv_store&quot;</TT> and <TT>&quot;hv_store_ent&quot;</TT> do not increment the
reference count of the stored <TT>&quot;val&quot;</TT>, which is the caller's responsibility.
If these functions return a <FONT SIZE="-1">NULL</FONT> value, the caller will usually have to
decrement the reference count of <TT>&quot;val&quot;</TT> to avoid a memory leak.
<A NAME="lbAM">&nbsp;</A>
<H2>AVs, HVs and undefined values

</H2>

<A NAME="ixAAM"></A>
Sometimes you have to store undefined values in AVs or HVs. Although
this may be a rare case, it can be tricky. That's because you're
used to using <TT>&amp;PL_sv_undef</TT> if you need an undefined <FONT SIZE="-1">SV</FONT>.
<P>

For example, intuition tells you that this <FONT SIZE="-1">XS</FONT> code:
<P>



<PRE>
    AV *av = newAV();
    av_store( av, 0, &amp;PL_sv_undef );

</PRE>


<P>

is equivalent to this Perl code:
<P>



<PRE>
    my @av;
    $av[0] = undef;

</PRE>


<P>

Unfortunately, this isn't true. AVs use <TT>&amp;PL_sv_undef</TT> as a marker
for indicating that an array element has not yet been initialized.
Thus, <TT>&quot;exists $av[0]&quot;</TT> would be true for the above Perl code, but
false for the array generated by the <FONT SIZE="-1">XS</FONT> code.
<P>

Other problems can occur when storing <TT>&amp;PL_sv_undef</TT> in HVs:
<P>



<PRE>
    hv_store( hv, &quot;key&quot;, 3, &amp;PL_sv_undef, 0 );

</PRE>


<P>

This will indeed make the value <TT>&quot;undef&quot;</TT>, but if you try to modify
the value of <TT>&quot;key&quot;</TT>, you'll get the following error:
<P>



<PRE>
    Modification of non-creatable hash value attempted

</PRE>


<P>

In perl 5.8.0, <TT>&amp;PL_sv_undef</TT> was also used to mark placeholders
in restricted hashes. This caused such hash entries not to appear
when iterating over the hash or when checking for the keys
with the <TT>&quot;hv_exists&quot;</TT> function.
<P>

You can run into similar problems when you store <TT>&amp;PL_sv_true</TT> or
<TT>&amp;PL_sv_false</TT> into AVs or HVs. Trying to modify such elements
will give you the following error:
<P>



<PRE>
    Modification of a read-only value attempted

</PRE>


<P>

To make a long story short, you can use the special variables
<TT>&amp;PL_sv_undef</TT>, <TT>&amp;PL_sv_true</TT> and <TT>&amp;PL_sv_false</TT> with AVs and
HVs, but you have to make sure you know what you're doing.
<P>

Generally, if you want to store an undefined value in an <FONT SIZE="-1">AV</FONT>
or <FONT SIZE="-1">HV</FONT>, you should not use <TT>&amp;PL_sv_undef</TT>, but rather create a
new undefined value using the <TT>&quot;newSV&quot;</TT> function, for example:
<P>



<PRE>
    av_store( av, 42, newSV(0) );
    hv_store( hv, &quot;foo&quot;, 3, newSV(0), 0 );

</PRE>


<A NAME="lbAN">&nbsp;</A>
<H2>References</H2>

<A NAME="ixAAN"></A>
References are a special type of scalar that point to other data types
(including references).
<P>

To create a reference, use either of the following functions:
<P>



<PRE>
    SV* newRV_inc((SV*) thing);
    SV* newRV_noinc((SV*) thing);

</PRE>


<P>

The <TT>&quot;thing&quot;</TT> argument can be any of an <TT>&quot;SV*&quot;</TT>, <TT>&quot;AV*&quot;</TT>, or <TT>&quot;HV*&quot;</TT>.  The
functions are identical except that <TT>&quot;newRV_inc&quot;</TT> increments the reference
count of the <TT>&quot;thing&quot;</TT>, while <TT>&quot;newRV_noinc&quot;</TT> does not.  For historical
reasons, <TT>&quot;newRV&quot;</TT> is a synonym for <TT>&quot;newRV_inc&quot;</TT>.
<P>

Once you have a reference, you can use the following macro to dereference
the reference:
<P>



<PRE>
    SvRV(SV*)

</PRE>


<P>

then call the appropriate routines, casting the returned <TT>&quot;SV*&quot;</TT> to either an
<TT>&quot;AV*&quot;</TT> or <TT>&quot;HV*&quot;</TT>, if required.
<P>

To determine if an <FONT SIZE="-1">SV</FONT> is a reference, you can use the following macro:
<P>



<PRE>
    SvROK(SV*)

</PRE>


<P>

To discover what type of value the reference refers to, use the following
macro and then check the return value.
<P>



<PRE>
    SvTYPE(SvRV(SV*))

</PRE>


<P>

The most useful types that will be returned are:
<P>



<PRE>
    SVt_IV    Scalar
    SVt_NV    Scalar
    SVt_PV    Scalar
    SVt_RV    Scalar
    SVt_PVAV  Array
    SVt_PVHV  Hash
    SVt_PVCV  Code
    SVt_PVGV  Glob (possible a file handle)
    SVt_PVMG  Blessed or Magical Scalar

</PRE>


<P>



<PRE>
    See the sv.h header file for more details.

</PRE>


<A NAME="lbAO">&nbsp;</A>
<H2>Blessed References and Class Objects</H2>

<A NAME="ixAAO"></A>
References are also used to support object-oriented programming.  In perl's
<FONT SIZE="-1">OO</FONT> lexicon, an object is simply a reference that has been blessed into a
package (or class).  Once blessed, the programmer may now use the reference
to access the various methods in the class.
<P>

A reference can be blessed into a package with the following function:
<P>



<PRE>
    SV* sv_bless(SV* sv, HV* stash);

</PRE>


<P>

The <TT>&quot;sv&quot;</TT> argument must be a reference value.  The <TT>&quot;stash&quot;</TT> argument
specifies which class the reference will belong to.  See
``Stashes and Globs'' for information on converting class names into stashes.
<P>

/* Still under construction */
<P>

Upgrades rv to reference if not already one.  Creates new <FONT SIZE="-1">SV</FONT> for rv to
point to.  If <TT>&quot;classname&quot;</TT> is non-null, the <FONT SIZE="-1">SV</FONT> is blessed into the specified
class.  <FONT SIZE="-1">SV</FONT> is returned.
<P>



<PRE>
        SV* newSVrv(SV* rv, const char* classname);

</PRE>


<P>

Copies integer, unsigned integer or double into an <FONT SIZE="-1">SV</FONT> whose reference is <TT>&quot;rv&quot;</TT>.  <FONT SIZE="-1">SV</FONT> is blessed
if <TT>&quot;classname&quot;</TT> is non-null.
<P>



<PRE>
        SV* sv_setref_iv(SV* rv, const char* classname, IV iv);
        SV* sv_setref_uv(SV* rv, const char* classname, UV uv);
        SV* sv_setref_nv(SV* rv, const char* classname, NV iv);

</PRE>


<P>

Copies the pointer value (<I>the address, not the string!</I>) into an <FONT SIZE="-1">SV</FONT> whose
reference is rv.  <FONT SIZE="-1">SV</FONT> is blessed if <TT>&quot;classname&quot;</TT> is non-null.
<P>



<PRE>
        SV* sv_setref_pv(SV* rv, const char* classname, PV iv);

</PRE>


<P>

Copies string into an <FONT SIZE="-1">SV</FONT> whose reference is <TT>&quot;rv&quot;</TT>.  Set length to 0 to let
Perl calculate the string length.  <FONT SIZE="-1">SV</FONT> is blessed if <TT>&quot;classname&quot;</TT> is non-null.
<P>



<PRE>
        SV* sv_setref_pvn(SV* rv, const char* classname, PV iv, STRLEN length);

</PRE>


<P>

Tests whether the <FONT SIZE="-1">SV</FONT> is blessed into the specified class.  It does not
check inheritance relationships.
<P>



<PRE>
        int  sv_isa(SV* sv, const char* name);

</PRE>


<P>

Tests whether the <FONT SIZE="-1">SV</FONT> is a reference to a blessed object.
<P>



<PRE>
        int  sv_isobject(SV* sv);

</PRE>


<P>

Tests whether the <FONT SIZE="-1">SV</FONT> is derived from the specified class. <FONT SIZE="-1">SV</FONT> can be either
a reference to a blessed object or a string containing a class name. This
is the function implementing the <TT>&quot;UNIVERSAL::isa&quot;</TT> functionality.
<P>



<PRE>
        bool sv_derived_from(SV* sv, const char* name);

</PRE>


<P>

To check if you've got an object derived from a specific class you have
to write:
<P>



<PRE>
        if (sv_isobject(sv) &amp;&amp; sv_derived_from(sv, class)) { ... }

</PRE>


<A NAME="lbAP">&nbsp;</A>
<H2>Creating New Variables</H2>

<A NAME="ixAAP"></A>
To create a new Perl variable with an undef value which can be accessed from
your Perl script, use the following routines, depending on the variable type.
<P>



<PRE>
    SV*  get_sv(&quot;package::varname&quot;, TRUE);
    AV*  get_av(&quot;package::varname&quot;, TRUE);
    HV*  get_hv(&quot;package::varname&quot;, TRUE);

</PRE>


<P>

Notice the use of <FONT SIZE="-1">TRUE</FONT> as the second parameter.  The new variable can now
be set, using the routines appropriate to the data type.
<P>

There are additional macros whose values may be bitwise <FONT SIZE="-1">OR</FONT>'ed with the
<TT>&quot;TRUE&quot;</TT> argument to enable certain extra features.  Those bits are:
<DL COMPACT>
<DT><FONT SIZE="-1">GV_ADDMULTI</FONT><DD>
<A NAME="ixAAQ"></A>
Marks the variable as multiply defined, thus preventing the:


<P>




<PRE>
  Name &lt;varname&gt; used only once: possible typo

</PRE>




<P>


warning.
<DT><FONT SIZE="-1">GV_ADDWARN</FONT><DD>
<A NAME="ixAAR"></A>
Issues the warning:


<P>




<PRE>
  Had to create &lt;varname&gt; unexpectedly

</PRE>




<P>


if the variable did not exist before the function was called.
</DL>
<P>

If you do not specify a package name, the variable is created in the current
package.
<A NAME="lbAQ">&nbsp;</A>
<H2>Reference Counts and Mortality</H2>

<A NAME="ixAAS"></A>
Perl uses a reference count-driven garbage collection mechanism. SVs,
AVs, or HVs (xV for short in the following) start their life with a
reference count of 1.  If the reference count of an xV ever drops to 0,
then it will be destroyed and its memory made available for reuse.
<P>

This normally doesn't happen at the Perl level unless a variable is
undef'ed or the last variable holding a reference to it is changed or
overwritten.  At the internal level, however, reference counts can be
manipulated with the following macros:
<P>



<PRE>
    int SvREFCNT(SV* sv);
    SV* SvREFCNT_inc(SV* sv);
    void SvREFCNT_dec(SV* sv);

</PRE>


<P>

However, there is one other function which manipulates the reference
count of its argument.  The <TT>&quot;newRV_inc&quot;</TT> function, you will recall,
creates a reference to the specified argument.  As a side effect,
it increments the argument's reference count.  If this is not what
you want, use <TT>&quot;newRV_noinc&quot;</TT> instead.
<P>

For example, imagine you want to return a reference from an <FONT SIZE="-1">XSUB</FONT> function.
Inside the <FONT SIZE="-1">XSUB</FONT> routine, you create an <FONT SIZE="-1">SV</FONT> which initially has a reference
count of one.  Then you call <TT>&quot;newRV_inc&quot;</TT>, passing it the just-created <FONT SIZE="-1">SV</FONT>.
This returns the reference as a new <FONT SIZE="-1">SV</FONT>, but the reference count of the
<FONT SIZE="-1">SV</FONT> you passed to <TT>&quot;newRV_inc&quot;</TT> has been incremented to two.  Now you
return the reference from the <FONT SIZE="-1">XSUB</FONT> routine and forget about the <FONT SIZE="-1">SV</FONT>.
But Perl hasn't!  Whenever the returned reference is destroyed, the
reference count of the original <FONT SIZE="-1">SV</FONT> is decreased to one and nothing happens.
The <FONT SIZE="-1">SV</FONT> will hang around without any way to access it until Perl itself
terminates.  This is a memory leak.
<P>

The correct procedure, then, is to use <TT>&quot;newRV_noinc&quot;</TT> instead of
<TT>&quot;newRV_inc&quot;</TT>.  Then, if and when the last reference is destroyed,
the reference count of the <FONT SIZE="-1">SV</FONT> will go to zero and it will be destroyed,
stopping any memory leak.
<P>

There are some convenience functions available that can help with the
destruction of xVs.  These functions introduce the concept of ``mortality''.
An xV that is mortal has had its reference count marked to be decremented,
but not actually decremented, until ``a short time later''.  Generally the
term ``short time later'' means a single Perl statement, such as a call to
an <FONT SIZE="-1">XSUB</FONT> function.  The actual determinant for when mortal xVs have their
reference count decremented depends on two macros, <FONT SIZE="-1">SAVETMPS</FONT> and <FONT SIZE="-1">FREETMPS</FONT>.
See perlcall and perlxs for more details on these macros.
<P>

``Mortalization'' then is at its simplest a deferred <TT>&quot;SvREFCNT_dec&quot;</TT>.
However, if you mortalize a variable twice, the reference count will
later be decremented twice.
<P>

``Mortal'' SVs are mainly used for SVs that are placed on perl's stack.
For example an <FONT SIZE="-1">SV</FONT> which is created just to pass a number to a called sub
is made mortal to have it cleaned up automatically when it's popped off
the stack. Similarly, results returned by XSUBs (which are pushed on the
stack) are often made mortal.
<P>

To create a mortal variable, use the functions:
<P>



<PRE>
    SV*  sv_newmortal()
    SV*  sv_2mortal(SV*)
    SV*  sv_mortalcopy(SV*)

</PRE>


<P>

The first call creates a mortal <FONT SIZE="-1">SV</FONT> (with no value), the second converts an existing
<FONT SIZE="-1">SV</FONT> to a mortal <FONT SIZE="-1">SV</FONT> (and thus defers a call to <TT>&quot;SvREFCNT_dec&quot;</TT>), and the
third creates a mortal copy of an existing <FONT SIZE="-1">SV</FONT>.
Because <TT>&quot;sv_newmortal&quot;</TT> gives the new <FONT SIZE="-1">SV</FONT> no value,it must normally be given one
via <TT>&quot;sv_setpv&quot;</TT>, <TT>&quot;sv_setiv&quot;</TT>, etc. :
<P>



<PRE>
    SV *tmp = sv_newmortal();
    sv_setiv(tmp, an_integer);

</PRE>


<P>

As that is multiple C statements it is quite common so see this idiom instead:
<P>



<PRE>
    SV *tmp = sv_2mortal(newSViv(an_integer));

</PRE>


<P>

You should be careful about creating mortal variables.  Strange things
can happen if you make the same value mortal within multiple contexts,
or if you make a variable mortal multiple times. Thinking of ``Mortalization''
as deferred <TT>&quot;SvREFCNT_dec&quot;</TT> should help to minimize such problems.
For example if you are passing an <FONT SIZE="-1">SV</FONT> which you <I>know</I> has high enough <FONT SIZE="-1">REFCNT</FONT>
to survive its use on the stack you need not do any mortalization.
If you are not sure then doing an <TT>&quot;SvREFCNT_inc&quot;</TT> and <TT>&quot;sv_2mortal&quot;</TT>, or
making a <TT>&quot;sv_mortalcopy&quot;</TT> is safer.
<P>

The mortal routines are not just for SVs --- AVs and HVs can be
made mortal by passing their address (type-casted to <TT>&quot;SV*&quot;</TT>) to the
<TT>&quot;sv_2mortal&quot;</TT> or <TT>&quot;sv_mortalcopy&quot;</TT> routines.
<A NAME="lbAR">&nbsp;</A>
<H2>Stashes and Globs</H2>

<A NAME="ixAAT"></A>
A <B>stash</B> is a hash that contains all variables that are defined
within a package.  Each key of the stash is a symbol
name (shared by all the different types of objects that have the same
name), and each value in the hash table is a <FONT SIZE="-1">GV</FONT> (Glob Value).  This <FONT SIZE="-1">GV</FONT>
in turn contains references to the various objects of that name,
including (but not limited to) the following:
<P>



<PRE>
    Scalar Value
    Array Value
    Hash Value
    I/O Handle
    Format
    Subroutine

</PRE>


<P>

There is a single stash called <TT>&quot;PL_defstash&quot;</TT> that holds the items that exist
in the <TT>&quot;main&quot;</TT> package.  To get at the items in other packages, append the
string ``::'' to the package name.  The items in the <TT>&quot;Foo&quot;</TT> package are in
the stash <TT>&quot;Foo::&quot;</TT> in PL_defstash.  The items in the <TT>&quot;Bar::Baz&quot;</TT> package are
in the stash <TT>&quot;Baz::&quot;</TT> in <TT>&quot;Bar::&quot;</TT>'s stash.
<P>

To get the stash pointer for a particular package, use the function:
<P>



<PRE>
    HV*  gv_stashpv(const char* name, I32 create)
    HV*  gv_stashsv(SV*, I32 create)

</PRE>


<P>

The first function takes a literal string, the second uses the string stored
in the <FONT SIZE="-1">SV</FONT>.  Remember that a stash is just a hash table, so you get back an
<TT>&quot;HV*&quot;</TT>.  The <TT>&quot;create&quot;</TT> flag will create a new package if it is set.
<P>

The name that <TT>&quot;gv_stash*v&quot;</TT> wants is the name of the package whose symbol table
you want.  The default package is called <TT>&quot;main&quot;</TT>.  If you have multiply nested
packages, pass their names to <TT>&quot;gv_stash*v&quot;</TT>, separated by <TT>&quot;::&quot;</TT> as in the Perl
language itself.
<P>

Alternately, if you have an <FONT SIZE="-1">SV</FONT> that is a blessed reference, you can find
out the stash pointer by using:
<P>



<PRE>
    HV*  SvSTASH(SvRV(SV*));

</PRE>


<P>

then use the following to get the package name itself:
<P>



<PRE>
    char*  HvNAME(HV* stash);

</PRE>


<P>

If you need to bless or re-bless an object you can use the following
function:
<P>



<PRE>
    SV*  sv_bless(SV*, HV* stash)

</PRE>


<P>

where the first argument, an <TT>&quot;SV*&quot;</TT>, must be a reference, and the second
argument is a stash.  The returned <TT>&quot;SV*&quot;</TT> can now be used in the same way
as any other <FONT SIZE="-1">SV</FONT>.
<P>

For more information on references and blessings, consult perlref.
<A NAME="lbAS">&nbsp;</A>
<H2>Double-Typed SVs</H2>

<A NAME="ixAAU"></A>
Scalar variables normally contain only one type of value, an integer,
double, pointer, or reference.  Perl will automatically convert the
actual scalar data from the stored type into the requested type.
<P>

Some scalar variables contain more than one type of scalar data.  For
example, the variable <TT>$!</TT> contains either the numeric value of <TT>&quot;errno&quot;</TT>
or its string equivalent from either <TT>&quot;strerror&quot;</TT> or <TT>&quot;sys_errlist[]&quot;</TT>.
<P>

To force multiple data values into an <FONT SIZE="-1">SV</FONT>, you must do two things: use the
<TT>&quot;sv_set*v&quot;</TT> routines to add the additional scalar type, then set a flag
so that Perl will believe it contains more than one type of data.  The
four macros to set the flags are:
<P>



<PRE>
        SvIOK_on
        SvNOK_on
        SvPOK_on
        SvROK_on

</PRE>


<P>

The particular macro you must use depends on which <TT>&quot;sv_set*v&quot;</TT> routine
you called first.  This is because every <TT>&quot;sv_set*v&quot;</TT> routine turns on
only the bit for the particular type of data being set, and turns off
all the rest.
<P>

For example, to create a new Perl variable called ``dberror'' that contains
both the numeric and descriptive string error values, you could use the
following code:
<P>



<PRE>
    extern int  dberror;
    extern char *dberror_list;

</PRE>


<P>



<PRE>
    SV* sv = get_sv(&quot;dberror&quot;, TRUE);
    sv_setiv(sv, (IV) dberror);
    sv_setpv(sv, dberror_list[dberror]);
    SvIOK_on(sv);

</PRE>


<P>

If the order of <TT>&quot;sv_setiv&quot;</TT> and <TT>&quot;sv_setpv&quot;</TT> had been reversed, then the
macro <TT>&quot;SvPOK_on&quot;</TT> would need to be called instead of <TT>&quot;SvIOK_on&quot;</TT>.
<A NAME="lbAT">&nbsp;</A>
<H2>Magic Variables</H2>

<A NAME="ixAAV"></A>
[This section still under construction.  Ignore everything here.  Post no
bills.  Everything not permitted is forbidden.]
<P>

Any <FONT SIZE="-1">SV</FONT> may be magical, that is, it has special features that a normal
<FONT SIZE="-1">SV</FONT> does not have.  These features are stored in the <FONT SIZE="-1">SV</FONT> structure in a
linked list of <TT>&quot;struct magic&quot;</TT>'s, typedef'ed to <TT>&quot;MAGIC&quot;</TT>.
<P>



<PRE>
    struct magic {
        MAGIC*      mg_moremagic;
        MGVTBL*     mg_virtual;
        U16         mg_private;
        char        mg_type;
        U8          mg_flags;
        SV*         mg_obj;
        char*       mg_ptr;
        I32         mg_len;
    };

</PRE>


<P>

Note this is current as of patchlevel 0, and could change at any time.
<A NAME="lbAU">&nbsp;</A>
<H2>Assigning Magic</H2>

<A NAME="ixAAW"></A>
Perl adds magic to an <FONT SIZE="-1">SV</FONT> using the sv_magic function:
<P>



<PRE>
    void sv_magic(SV* sv, SV* obj, int how, const char* name, I32 namlen);

</PRE>


<P>

The <TT>&quot;sv&quot;</TT> argument is a pointer to the <FONT SIZE="-1">SV</FONT> that is to acquire a new magical
feature.
<P>

If <TT>&quot;sv&quot;</TT> is not already magical, Perl uses the <TT>&quot;SvUPGRADE&quot;</TT> macro to
convert <TT>&quot;sv&quot;</TT> to type <TT>&quot;SVt_PVMG&quot;</TT>. Perl then continues by adding new magic
to the beginning of the linked list of magical features.  Any prior entry
of the same type of magic is deleted.  Note that this can be overridden,
and multiple instances of the same type of magic can be associated with an
<FONT SIZE="-1">SV</FONT>.
<P>

The <TT>&quot;name&quot;</TT> and <TT>&quot;namlen&quot;</TT> arguments are used to associate a string with
the magic, typically the name of a variable. <TT>&quot;namlen&quot;</TT> is stored in the
<TT>&quot;mg_len&quot;</TT> field and if <TT>&quot;name&quot;</TT> is non-null and <TT>&quot;namlen&quot;</TT> &gt;= 0 a malloc'd
copy of the name is stored in <TT>&quot;mg_ptr&quot;</TT> field.
<P>

The sv_magic function uses <TT>&quot;how&quot;</TT> to determine which, if any, predefined
``Magic Virtual Table'' should be assigned to the <TT>&quot;mg_virtual&quot;</TT> field.
See the ``Magic Virtual Tables'' section below.  The <TT>&quot;how&quot;</TT> argument is also
stored in the <TT>&quot;mg_type&quot;</TT> field. The value of <TT>&quot;how&quot;</TT> should be chosen
from the set of macros <TT>&quot;PERL_MAGIC_foo&quot;</TT> found in <I>perl.h</I>. Note that before
these macros were added, Perl internals used to directly use character
literals, so you may occasionally come across old code or documentation
referring to 'U' magic rather than <TT>&quot;PERL_MAGIC_uvar&quot;</TT> for example.
<P>

The <TT>&quot;obj&quot;</TT> argument is stored in the <TT>&quot;mg_obj&quot;</TT> field of the <TT>&quot;MAGIC&quot;</TT>
structure.  If it is not the same as the <TT>&quot;sv&quot;</TT> argument, the reference
count of the <TT>&quot;obj&quot;</TT> object is incremented.  If it is the same, or if
the <TT>&quot;how&quot;</TT> argument is <TT>&quot;PERL_MAGIC_arylen&quot;</TT>, or if it is a <FONT SIZE="-1">NULL</FONT> pointer,
then <TT>&quot;obj&quot;</TT> is merely stored, without the reference count being incremented.
<P>

There is also a function to add magic to an <TT>&quot;HV&quot;</TT>:
<P>



<PRE>
    void hv_magic(HV *hv, GV *gv, int how);

</PRE>


<P>

This simply calls <TT>&quot;sv_magic&quot;</TT> and coerces the <TT>&quot;gv&quot;</TT> argument into an <TT>&quot;SV&quot;</TT>.
<P>

To remove the magic from an <FONT SIZE="-1">SV</FONT>, call the function sv_unmagic:
<P>



<PRE>
    void sv_unmagic(SV *sv, int type);

</PRE>


<P>

The <TT>&quot;type&quot;</TT> argument should be equal to the <TT>&quot;how&quot;</TT> value when the <TT>&quot;SV&quot;</TT>
was initially made magical.
<A NAME="lbAV">&nbsp;</A>
<H2>Magic Virtual Tables</H2>

<A NAME="ixAAX"></A>
The <TT>&quot;mg_virtual&quot;</TT> field in the <TT>&quot;MAGIC&quot;</TT> structure is a pointer to an
<TT>&quot;MGVTBL&quot;</TT>, which is a structure of function pointers and stands for
``Magic Virtual Table'' to handle the various operations that might be
applied to that variable.
<P>

The <TT>&quot;MGVTBL&quot;</TT> has five pointers to the following routine types:
<P>



<PRE>
    int  (*svt_get)(SV* sv, MAGIC* mg);
    int  (*svt_set)(SV* sv, MAGIC* mg);
    U32  (*svt_len)(SV* sv, MAGIC* mg);
    int  (*svt_clear)(SV* sv, MAGIC* mg);
    int  (*svt_free)(SV* sv, MAGIC* mg);

</PRE>


<P>

This <FONT SIZE="-1">MGVTBL</FONT> structure is set at compile-time in <I>perl.h</I> and there are
currently 19 types (or 21 with overloading turned on).  These different
structures contain pointers to various routines that perform additional
actions depending on which function is being called.
<P>



<PRE>
    Function pointer    Action taken
    ----------------    ------------
    svt_get             Do something before the value of the SV is retrieved.
    svt_set             Do something after the SV is assigned a value.
    svt_len             Report on the SV's length.
    svt_clear           Clear something the SV represents.
    svt_free            Free any extra storage associated with the SV.

</PRE>


<P>

For instance, the <FONT SIZE="-1">MGVTBL</FONT> structure called <TT>&quot;vtbl_sv&quot;</TT> (which corresponds
to an <TT>&quot;mg_type&quot;</TT> of <TT>&quot;PERL_MAGIC_sv&quot;</TT>) contains:
<P>



<PRE>
    { magic_get, magic_set, magic_len, 0, 0 }

</PRE>


<P>

Thus, when an <FONT SIZE="-1">SV</FONT> is determined to be magical and of type <TT>&quot;PERL_MAGIC_sv&quot;</TT>,
if a get operation is being performed, the routine <TT>&quot;magic_get&quot;</TT> is
called.  All the various routines for the various magical types begin
with <TT>&quot;magic_&quot;</TT>.  <FONT SIZE="-1">NOTE:</FONT> the magic routines are not considered part of
the Perl <FONT SIZE="-1">API</FONT>, and may not be exported by the Perl library.
<P>

The current kinds of Magic Virtual Tables are:
<P>



<PRE>
    mg_type
    (old-style char and macro)   MGVTBL         Type of magic
    --------------------------   ------         ----------------------------
    \0 PERL_MAGIC_sv             vtbl_sv        Special scalar variable
    A  PERL_MAGIC_overload       vtbl_amagic    %OVERLOAD hash
    a  PERL_MAGIC_overload_elem  vtbl_amagicelem %OVERLOAD hash element
    c  PERL_MAGIC_overload_table (none)         Holds overload table (AMT)
                                                on stash
    B  PERL_MAGIC_bm             vtbl_bm        Boyer-Moore (fast string search)
    D  PERL_MAGIC_regdata        vtbl_regdata   Regex match position data
                                                (@+ and @- vars)
    d  PERL_MAGIC_regdatum       vtbl_regdatum  Regex match position data
                                                element
    E  PERL_MAGIC_env            vtbl_env       %ENV hash
    e  PERL_MAGIC_envelem        vtbl_envelem   %ENV hash element
    f  PERL_MAGIC_fm             vtbl_fm        Formline ('compiled' format)
    g  PERL_MAGIC_regex_global   vtbl_mglob     m//g target / study()ed string
    I  PERL_MAGIC_isa            vtbl_isa       @ISA array
    i  PERL_MAGIC_isaelem        vtbl_isaelem   @ISA array element
    k  PERL_MAGIC_nkeys          vtbl_nkeys     scalar(keys()) lvalue
    L  PERL_MAGIC_dbfile         (none)         Debugger %_&lt;filename
    l  PERL_MAGIC_dbline         vtbl_dbline    Debugger %_&lt;filename element
    m  PERL_MAGIC_mutex          vtbl_mutex     ???
    o  PERL_MAGIC_collxfrm       vtbl_collxfrm  Locale collate transformation
    P  PERL_MAGIC_tied           vtbl_pack      Tied array or hash
    p  PERL_MAGIC_tiedelem       vtbl_packelem  Tied array or hash element
    q  PERL_MAGIC_tiedscalar     vtbl_packelem  Tied scalar or handle
    r  PERL_MAGIC_qr             vtbl_qr        precompiled qr// regex
    S  PERL_MAGIC_sig            vtbl_sig       %SIG hash
    s  PERL_MAGIC_sigelem        vtbl_sigelem   %SIG hash element
    t  PERL_MAGIC_taint          vtbl_taint     Taintedness
    U  PERL_MAGIC_uvar           vtbl_uvar      Available for use by extensions
    v  PERL_MAGIC_vec            vtbl_vec       vec() lvalue
    V  PERL_MAGIC_vstring        (none)         v-string scalars
    w  PERL_MAGIC_utf8           vtbl_utf8      UTF-8 length+offset cache
    x  PERL_MAGIC_substr         vtbl_substr    substr() lvalue
    y  PERL_MAGIC_defelem        vtbl_defelem   Shadow &quot;foreach&quot; iterator
                                                variable / smart parameter
                                                vivification
    *  PERL_MAGIC_glob           vtbl_glob      GV (typeglob)
    #  PERL_MAGIC_arylen         vtbl_arylen    Array length ($#ary)
    .  PERL_MAGIC_pos            vtbl_pos       pos() lvalue
    &lt;  PERL_MAGIC_backref        vtbl_backref   ???
    ~  PERL_MAGIC_ext            (none)         Available for use by extensions

</PRE>


<P>

When an uppercase and lowercase letter both exist in the table, then the
uppercase letter is typically used to represent some kind of composite type
(a list or a hash), and the lowercase letter is used to represent an element
of that composite type. Some internals code makes use of this case
relationship.  However, 'v' and 'V' (vec and v-string) are in no way related.
<P>

The <TT>&quot;PERL_MAGIC_ext&quot;</TT> and <TT>&quot;PERL_MAGIC_uvar&quot;</TT> magic types are defined
specifically for use by extensions and will not be used by perl itself.
Extensions can use <TT>&quot;PERL_MAGIC_ext&quot;</TT> magic to 'attach' private information
to variables (typically objects).  This is especially useful because
there is no way for normal perl code to corrupt this private information
(unlike using extra elements of a hash object).
<P>

Similarly, <TT>&quot;PERL_MAGIC_uvar&quot;</TT> magic can be used much like <I>tie()</I> to call a
C function any time a scalar's value is used or changed.  The <TT>&quot;MAGIC&quot;</TT>'s
<TT>&quot;mg_ptr&quot;</TT> field points to a <TT>&quot;ufuncs&quot;</TT> structure:
<P>



<PRE>
    struct ufuncs {
        I32 (*uf_val)(pTHX_ IV, SV*);
        I32 (*uf_set)(pTHX_ IV, SV*);
        IV uf_index;
    };

</PRE>


<P>

When the <FONT SIZE="-1">SV</FONT> is read from or written to, the <TT>&quot;uf_val&quot;</TT> or <TT>&quot;uf_set&quot;</TT>
function will be called with <TT>&quot;uf_index&quot;</TT> as the first arg and a pointer to
the <FONT SIZE="-1">SV</FONT> as the second.  A simple example of how to add <TT>&quot;PERL_MAGIC_uvar&quot;</TT>
magic is shown below.  Note that the ufuncs structure is copied by
sv_magic, so you can safely allocate it on the stack.
<P>



<PRE>
    void
    Umagic(sv)
        SV *sv;
    PREINIT:
        struct ufuncs uf;
    CODE:
        uf.uf_val   = &amp;my_get_fn;
        uf.uf_set   = &amp;my_set_fn;
        uf.uf_index = 0;
        sv_magic(sv, 0, PERL_MAGIC_uvar, (char*)&amp;uf, sizeof(uf));

</PRE>


<P>

Note that because multiple extensions may be using <TT>&quot;PERL_MAGIC_ext&quot;</TT>
or <TT>&quot;PERL_MAGIC_uvar&quot;</TT> magic, it is important for extensions to take
extra care to avoid conflict.  Typically only using the magic on
objects blessed into the same class as the extension is sufficient.
For <TT>&quot;PERL_MAGIC_ext&quot;</TT> magic, it may also be appropriate to add an I32
'signature' at the top of the private data area and check that.
<P>

Also note that the <TT>&quot;sv_set*()&quot;</TT> and <TT>&quot;sv_cat*()&quot;</TT> functions described
earlier do <B>not</B> invoke 'set' magic on their targets.  This must
be done by the user either by calling the <TT>&quot;SvSETMAGIC()&quot;</TT> macro after
calling these functions, or by using one of the <TT>&quot;sv_set*_mg()&quot;</TT> or
<TT>&quot;sv_cat*_mg()&quot;</TT> functions.  Similarly, generic C code must call the
<TT>&quot;SvGETMAGIC()&quot;</TT> macro to invoke any 'get' magic if they use an <FONT SIZE="-1">SV</FONT>
obtained from external sources in functions that don't handle magic.
See perlapi for a description of these functions.
For example, calls to the <TT>&quot;sv_cat*()&quot;</TT> functions typically need to be
followed by <TT>&quot;SvSETMAGIC()&quot;</TT>, but they don't need a prior <TT>&quot;SvGETMAGIC()&quot;</TT>
since their implementation handles 'get' magic.
<A NAME="lbAW">&nbsp;</A>
<H2>Finding Magic</H2>

<A NAME="ixAAY"></A>


<PRE>
    MAGIC* mg_find(SV*, int type); /* Finds the magic pointer of that type */

</PRE>


<P>

This routine returns a pointer to the <TT>&quot;MAGIC&quot;</TT> structure stored in the <FONT SIZE="-1">SV</FONT>.
If the <FONT SIZE="-1">SV</FONT> does not have that magical feature, <TT>&quot;NULL&quot;</TT> is returned.  Also,
if the <FONT SIZE="-1">SV</FONT> is not of type SVt_PVMG, Perl may core dump.
<P>



<PRE>
    int mg_copy(SV* sv, SV* nsv, const char* key, STRLEN klen);

</PRE>


<P>

This routine checks to see what types of magic <TT>&quot;sv&quot;</TT> has.  If the mg_type
field is an uppercase letter, then the mg_obj is copied to <TT>&quot;nsv&quot;</TT>, but
the mg_type field is changed to be the lowercase letter.
<A NAME="lbAX">&nbsp;</A>
<H2>Understanding the Magic of Tied Hashes and Arrays</H2>

<A NAME="ixAAZ"></A>
Tied hashes and arrays are magical beasts of the <TT>&quot;PERL_MAGIC_tied&quot;</TT>
magic type.
<P>

<FONT SIZE="-1">WARNING:</FONT> As of the 5.004 release, proper usage of the array and hash
access functions requires understanding a few caveats.  Some
of these caveats are actually considered bugs in the <FONT SIZE="-1">API</FONT>, to be fixed
in later releases, and are bracketed with [<FONT SIZE="-1">MAYCHANGE</FONT>] below. If
you find yourself actually applying such information in this section, be
aware that the behavior may change in the future, umm, without warning.
<P>

The perl tie function associates a variable with an object that implements
the various <FONT SIZE="-1">GET</FONT>, <FONT SIZE="-1">SET</FONT>, etc methods.  To perform the equivalent of the perl
tie function from an <FONT SIZE="-1">XSUB</FONT>, you must mimic this behaviour.  The code below
carries out the necessary steps - firstly it creates a new hash, and then
creates a second hash which it blesses into the class which will implement
the tie methods. Lastly it ties the two hashes together, and returns a
reference to the new tied hash.  Note that the code below does <FONT SIZE="-1">NOT</FONT> call the
<FONT SIZE="-1">TIEHASH</FONT> method in the MyTie class -
see ``Calling Perl Routines from within C Programs'' for details on how
to do this.
<P>



<PRE>
    SV*
    mytie()
    PREINIT:
        HV *hash;
        HV *stash;
        SV *tie;
    CODE:
        hash = newHV();
        tie = newRV_noinc((SV*)newHV());
        stash = gv_stashpv(&quot;MyTie&quot;, TRUE);
        sv_bless(tie, stash);
        hv_magic(hash, (GV*)tie, PERL_MAGIC_tied);
        RETVAL = newRV_noinc(hash);
    OUTPUT:
        RETVAL

</PRE>


<P>

The <TT>&quot;av_store&quot;</TT> function, when given a tied array argument, merely
copies the magic of the array onto the value to be ``stored'', using
<TT>&quot;mg_copy&quot;</TT>.  It may also return <FONT SIZE="-1">NULL</FONT>, indicating that the value did not
actually need to be stored in the array.  [<FONT SIZE="-1">MAYCHANGE</FONT>] After a call to
<TT>&quot;av_store&quot;</TT> on a tied array, the caller will usually need to call
<TT>&quot;mg_set(val)&quot;</TT> to actually invoke the perl level ``<FONT SIZE="-1">STORE</FONT>'' method on the
<FONT SIZE="-1">TIEARRAY</FONT> object.  If <TT>&quot;av_store&quot;</TT> did return <FONT SIZE="-1">NULL</FONT>, a call to
<TT>&quot;SvREFCNT_dec(val)&quot;</TT> will also be usually necessary to avoid a memory
leak. [/MAYCHANGE]
<P>

The previous paragraph is applicable verbatim to tied hash access using the
<TT>&quot;hv_store&quot;</TT> and <TT>&quot;hv_store_ent&quot;</TT> functions as well.
<P>

<TT>&quot;av_fetch&quot;</TT> and the corresponding hash functions <TT>&quot;hv_fetch&quot;</TT> and
<TT>&quot;hv_fetch_ent&quot;</TT> actually return an undefined mortal value whose magic
has been initialized using <TT>&quot;mg_copy&quot;</TT>.  Note the value so returned does not
need to be deallocated, as it is already mortal.  [<FONT SIZE="-1">MAYCHANGE</FONT>] But you will
need to call <TT>&quot;mg_get()&quot;</TT> on the returned value in order to actually invoke
the perl level ``<FONT SIZE="-1">FETCH</FONT>'' method on the underlying <FONT SIZE="-1">TIE</FONT> object.  Similarly,
you may also call <TT>&quot;mg_set()&quot;</TT> on the return value after possibly assigning
a suitable value to it using <TT>&quot;sv_setsv&quot;</TT>,  which will invoke the ``<FONT SIZE="-1">STORE</FONT>''
method on the <FONT SIZE="-1">TIE</FONT> object. [/MAYCHANGE]
<P>

[<FONT SIZE="-1">MAYCHANGE</FONT>]
In other words, the array or hash fetch/store functions don't really
fetch and store actual values in the case of tied arrays and hashes.  They
merely call <TT>&quot;mg_copy&quot;</TT> to attach magic to the values that were meant to be
``stored'' or ``fetched''.  Later calls to <TT>&quot;mg_get&quot;</TT> and <TT>&quot;mg_set&quot;</TT> actually
do the job of invoking the <FONT SIZE="-1">TIE</FONT> methods on the underlying objects.  Thus
the magic mechanism currently implements a kind of lazy access to arrays
and hashes.
<P>

Currently (as of perl version 5.004), use of the hash and array access
functions requires the user to be aware of whether they are operating on
``normal'' hashes and arrays, or on their tied variants.  The <FONT SIZE="-1">API</FONT> may be
changed to provide more transparent access to both tied and normal data
types in future versions.
[/MAYCHANGE]
<P>

You would do well to understand that the <FONT SIZE="-1">TIEARRAY</FONT> and <FONT SIZE="-1">TIEHASH</FONT> interfaces
are mere sugar to invoke some perl method calls while using the uniform hash
and array syntax.  The use of this sugar imposes some overhead (typically
about two to four extra opcodes per <FONT SIZE="-1">FETCH/STORE</FONT> operation, in addition to
the creation of all the mortal variables required to invoke the methods).
This overhead will be comparatively small if the <FONT SIZE="-1">TIE</FONT> methods are themselves
substantial, but if they are only a few statements long, the overhead
will not be insignificant.
<A NAME="lbAY">&nbsp;</A>
<H2>Localizing changes</H2>

<A NAME="ixABA"></A>
Perl has a very handy construction
<P>



<PRE>
  {
    local $var = 2;
    ...
  }

</PRE>


<P>

This construction is <I>approximately</I> equivalent to
<P>



<PRE>
  {
    my $oldvar = $var;
    $var = 2;
    ...
    $var = $oldvar;
  }

</PRE>


<P>

The biggest difference is that the first construction would
reinstate the initial value of <TT>$var</TT>, irrespective of how control exits
the block: <TT>&quot;goto&quot;</TT>, <TT>&quot;return&quot;</TT>, <TT>&quot;die&quot;</TT>/<TT>&quot;eval&quot;</TT>, etc. It is a little bit
more efficient as well.
<P>

There is a way to achieve a similar task from C via Perl <FONT SIZE="-1">API:</FONT> create a
<I>pseudo-block</I>, and arrange for some changes to be automatically
undone at the end of it, either explicit, or via a non-local exit (via
<I>die()</I>). A <I>block</I>-like construct is created by a pair of
<TT>&quot;ENTER&quot;</TT>/<TT>&quot;LEAVE&quot;</TT> macros (see ``Returning a Scalar'' in perlcall).
Such a construct may be created specially for some important localized
task, or an existing one (like boundaries of enclosing Perl
subroutine/block, or an existing pair for freeing TMPs) may be
used. (In the second case the overhead of additional localization must
be almost negligible.) Note that any <FONT SIZE="-1">XSUB</FONT> is automatically enclosed in
an <TT>&quot;ENTER&quot;</TT>/<TT>&quot;LEAVE&quot;</TT> pair.
<P>

Inside such a <I>pseudo-block</I> the following service is available:
<DL COMPACT>
<DT>SAVEINT(int i)<DD>


<A NAME="ixABB"></A>

<DT>SAVEIV(IV i)<DD>


<A NAME="ixABC"></A>
<DT>SAVEI32(I32 i)<DD>


<A NAME="ixABD"></A>
<DT>SAVELONG(long i)<DD>


<A NAME="ixABE"></A>

These macros arrange things to restore the value of integer variable
<TT>&quot;i&quot;</TT> at the end of enclosing <I>pseudo-block</I>.
<DT>SAVESPTR(s)<DD>


<A NAME="ixABF"></A>

<DT>SAVEPPTR(p)<DD>


<A NAME="ixABG"></A>

These macros arrange things to restore the value of pointers <TT>&quot;s&quot;</TT> and
<TT>&quot;p&quot;</TT>. <TT>&quot;s&quot;</TT> must be a pointer of a type which survives conversion to
<TT>&quot;SV*&quot;</TT> and back, <TT>&quot;p&quot;</TT> should be able to survive conversion to <TT>&quot;char*&quot;</TT>
and back.
<DT>SAVEFREESV(SV *sv)<DD>


<A NAME="ixABH"></A>
The refcount of <TT>&quot;sv&quot;</TT> would be decremented at the end of
<I>pseudo-block</I>.  This is similar to <TT>&quot;sv_2mortal&quot;</TT> in that it is also a
mechanism for doing a delayed <TT>&quot;SvREFCNT_dec&quot;</TT>.  However, while <TT>&quot;sv_2mortal&quot;</TT>
extends the lifetime of <TT>&quot;sv&quot;</TT> until the beginning of the next statement,
<TT>&quot;SAVEFREESV&quot;</TT> extends it until the end of the enclosing scope.  These
lifetimes can be wildly different.


<P>


Also compare <TT>&quot;SAVEMORTALIZESV&quot;</TT>.
<DT>SAVEMORTALIZESV(SV *sv)<DD>


<A NAME="ixABI"></A>
Just like <TT>&quot;SAVEFREESV&quot;</TT>, but mortalizes <TT>&quot;sv&quot;</TT> at the end of the current
scope instead of decrementing its reference count.  This usually has the
effect of keeping <TT>&quot;sv&quot;</TT> alive until the statement that called the currently
live scope has finished executing.
<DT>SAVEFREEOP(OP *op)<DD>


<A NAME="ixABJ"></A>
The <TT>&quot;OP *&quot;</TT> is <I>op_free()</I>ed at the end of <I>pseudo-block</I>.
<DT>SAVEFREEPV(p)<DD>


<A NAME="ixABK"></A>
The chunk of memory which is pointed to by <TT>&quot;p&quot;</TT> is <I>Safefree()</I>ed at the
end of <I>pseudo-block</I>.
<DT>SAVECLEARSV(SV *sv)<DD>


<A NAME="ixABL"></A>
Clears a slot in the current scratchpad which corresponds to <TT>&quot;sv&quot;</TT> at
the end of <I>pseudo-block</I>.
<DT>SAVEDELETE(HV *hv, char *key, I32 length)<DD>


<A NAME="ixABM"></A>
The key <TT>&quot;key&quot;</TT> of <TT>&quot;hv&quot;</TT> is deleted at the end of <I>pseudo-block</I>. The
string pointed to by <TT>&quot;key&quot;</TT> is <I>Safefree()</I>ed.  If one has a <I>key</I> in
short-lived storage, the corresponding string may be reallocated like
this:


<P>




<PRE>
  SAVEDELETE(PL_defstash, savepv(tmpbuf), strlen(tmpbuf));

</PRE>


<DT>SAVEDESTRUCTOR(DESTRUCTORFUNC_NOCONTEXT_t f, void *p)<DD>


<A NAME="ixABN"></A>
At the end of <I>pseudo-block</I> the function <TT>&quot;f&quot;</TT> is called with the
only argument <TT>&quot;p&quot;</TT>.
<DT>SAVEDESTRUCTOR_X(DESTRUCTORFUNC_t f, void *p)<DD>


<A NAME="ixABO"></A>
At the end of <I>pseudo-block</I> the function <TT>&quot;f&quot;</TT> is called with the
implicit context argument (if any), and <TT>&quot;p&quot;</TT>.
<DT>SAVESTACK_POS()<DD>


<A NAME="ixABP"></A>
The current offset on the Perl internal stack (cf. <TT>&quot;SP&quot;</TT>) is restored
at the end of <I>pseudo-block</I>.
</DL>
<P>

The following <FONT SIZE="-1">API</FONT> list contains functions, thus one needs to
provide pointers to the modifiable data explicitly (either C pointers,
or Perlish <TT>&quot;GV *&quot;</TT>s).  Where the above macros take <TT>&quot;int&quot;</TT>, a similar
function takes <TT>&quot;int *&quot;</TT>.
<DL COMPACT>
<DT>SV* save_scalar(GV *gv)<DD>


<A NAME="ixABQ"></A>
Equivalent to Perl code <TT>&quot;local $gv&quot;</TT>.
<DT>AV* save_ary(GV *gv)<DD>


<A NAME="ixABR"></A>

<DT>HV* save_hash(GV *gv)<DD>


<A NAME="ixABS"></A>

Similar to <TT>&quot;save_scalar&quot;</TT>, but localize <TT>@gv</TT> and <TT>%gv</TT>.
<DT>void save_item(SV *item)<DD>


<A NAME="ixABT"></A>
Duplicates the current value of <TT>&quot;SV&quot;</TT>, on the exit from the current
<TT>&quot;ENTER&quot;</TT>/<TT>&quot;LEAVE&quot;</TT> <I>pseudo-block</I> will restore the value of <TT>&quot;SV&quot;</TT>
using the stored value.
<DT>void save_list(SV **sarg, I32 maxsarg)<DD>


<A NAME="ixABU"></A>
A variant of <TT>&quot;save_item&quot;</TT> which takes multiple arguments via an array
<TT>&quot;sarg&quot;</TT> of <TT>&quot;SV*&quot;</TT> of length <TT>&quot;maxsarg&quot;</TT>.
<DT>SV* save_svref(SV **sptr)<DD>


<A NAME="ixABV"></A>
Similar to <TT>&quot;save_scalar&quot;</TT>, but will reinstate an <TT>&quot;SV *&quot;</TT>.
<DT>void save_aptr(AV **aptr)<DD>


<A NAME="ixABW"></A>

<DT>void save_hptr(HV **hptr)<DD>


<A NAME="ixABX"></A>

Similar to <TT>&quot;save_svref&quot;</TT>, but localize <TT>&quot;AV *&quot;</TT> and <TT>&quot;HV *&quot;</TT>.
</DL>
<P>

The <TT>&quot;Alias&quot;</TT> module implements localization of the basic types within the
<I>caller's scope</I>.  People who are interested in how to localize things in
the containing scope should take a look there too.
<A NAME="lbAZ">&nbsp;</A>
<H2>Subroutines</H2>

<A NAME="ixABY"></A>
<A NAME="lbBA">&nbsp;</A>
<H2>XSUBs and the Argument Stack

</H2>

<A NAME="ixABZ"></A>
The <FONT SIZE="-1">XSUB</FONT> mechanism is a simple way for Perl programs to access C subroutines.
An <FONT SIZE="-1">XSUB</FONT> routine will have a stack that contains the arguments from the Perl
program, and a way to map from the Perl data structures to a C equivalent.
<P>

The stack arguments are accessible through the <TT><A HREF="../mann/ST.n.php">ST</A>(n)</TT> macro, which returns
the <TT>&quot;n&quot;</TT>'th stack argument.  Argument 0 is the first argument passed in the
Perl subroutine call.  These arguments are <TT>&quot;SV*&quot;</TT>, and can be used anywhere
an <TT>&quot;SV*&quot;</TT> is used.
<P>

Most of the time, output from the C routine can be handled through use of
the <FONT SIZE="-1">RETVAL</FONT> and <FONT SIZE="-1">OUTPUT</FONT> directives.  However, there are some cases where the
argument stack is not already long enough to handle all the return values.
An example is the <FONT SIZE="-1">POSIX</FONT> <I>tzname()</I> call, which takes no arguments, but returns
two, the local time zone's standard and summer time abbreviations.
<P>

To handle this situation, the <FONT SIZE="-1">PPCODE</FONT> directive is used and the stack is
extended using the macro:
<P>



<PRE>
    EXTEND(SP, num);

</PRE>


<P>

where <TT>&quot;SP&quot;</TT> is the macro that represents the local copy of the stack pointer,
and <TT>&quot;num&quot;</TT> is the number of elements the stack should be extended by.
<P>

Now that there is room on the stack, values can be pushed on it using <TT>&quot;PUSHs&quot;</TT>
macro. The pushed values will often need to be ``mortal'' (See
``Reference Counts and Mortality''):
<P>



<PRE>
    PUSHs(sv_2mortal(newSViv(an_integer)))
    PUSHs(sv_2mortal(newSVuv(an_unsigned_integer)))
    PUSHs(sv_2mortal(newSVnv(a_double)))
    PUSHs(sv_2mortal(newSVpv(&quot;Some String&quot;,0)))

</PRE>


<P>

And now the Perl program calling <TT>&quot;tzname&quot;</TT>, the two values will be assigned
as in:
<P>



<PRE>
    ($standard_abbrev, $summer_abbrev) = POSIX::tzname;

</PRE>


<P>

An alternate (and possibly simpler) method to pushing values on the stack is
to use the macro:
<P>



<PRE>
    XPUSHs(SV*)

</PRE>


<P>

This macro automatically adjust the stack for you, if needed.  Thus, you
do not need to call <TT>&quot;EXTEND&quot;</TT> to extend the stack.
<P>

Despite their suggestions in earlier versions of this document the macros
<TT>&quot;(X)PUSH[iunp]&quot;</TT> are <I>not</I> suited to XSUBs which return multiple results.
For that, either stick to the <TT>&quot;(X)PUSHs&quot;</TT> macros shown above, or use the new
<TT>&quot;m(X)PUSH[iunp]&quot;</TT> macros instead; see ``Putting a C value on Perl stack''.
<P>

For more information, consult perlxs and perlxstut.
<A NAME="lbBB">&nbsp;</A>
<H2>Calling Perl Routines from within C Programs</H2>

<A NAME="ixACA"></A>
There are four routines that can be used to call a Perl subroutine from
within a C program.  These four are:
<P>



<PRE>
    I32  call_sv(SV*, I32);
    I32  call_pv(const char*, I32);
    I32  call_method(const char*, I32);
    I32  call_argv(const char*, I32, register char**);

</PRE>


<P>

The routine most often used is <TT>&quot;call_sv&quot;</TT>.  The <TT>&quot;SV*&quot;</TT> argument
contains either the name of the Perl subroutine to be called, or a
reference to the subroutine.  The second argument consists of flags
that control the context in which the subroutine is called, whether
or not the subroutine is being passed arguments, how errors should be
trapped, and how to treat return values.
<P>

All four routines return the number of arguments that the subroutine returned
on the Perl stack.
<P>

These routines used to be called <TT>&quot;perl_call_sv&quot;</TT>, etc., before Perl v5.6.0,
but those names are now deprecated; macros of the same name are provided for
compatibility.
<P>

When using any of these routines (except <TT>&quot;call_argv&quot;</TT>), the programmer
must manipulate the Perl stack.  These include the following macros and
functions:
<P>



<PRE>
    dSP
    SP
    PUSHMARK()
    PUTBACK
    SPAGAIN
    ENTER
    SAVETMPS
    FREETMPS
    LEAVE
    XPUSH*()
    POP*()

</PRE>


<P>

For a detailed description of calling conventions from C to Perl,
consult perlcall.
<A NAME="lbBC">&nbsp;</A>
<H2>Memory Allocation</H2>

<A NAME="ixACB"></A>
<I>Allocation</I>
<A NAME="ixACC"></A>
<P>

All memory meant to be used with the Perl <FONT SIZE="-1">API</FONT> functions should be manipulated
using the macros described in this section.  The macros provide the necessary
transparency between differences in the actual malloc implementation that is
used within perl.
<P>

It is suggested that you enable the version of malloc that is distributed
with Perl.  It keeps pools of various sizes of unallocated memory in
order to satisfy allocation requests more quickly.  However, on some
platforms, it may cause spurious malloc or free errors.
<P>

The following three macros are used to initially allocate memory :
<P>



<PRE>
    New(x, pointer, number, type);
    Newc(x, pointer, number, type, cast);
    Newz(x, pointer, number, type);

</PRE>


<P>

The first argument <TT>&quot;x&quot;</TT> was a ``magic cookie'' that was used to keep track
of who called the macro, to help when debugging memory problems.  However,
the current code makes no use of this feature (most Perl developers now
use run-time memory checkers), so this argument can be any number.
<P>

The second argument <TT>&quot;pointer&quot;</TT> should be the name of a variable that will
point to the newly allocated memory.
<P>

The third and fourth arguments <TT>&quot;number&quot;</TT> and <TT>&quot;type&quot;</TT> specify how many of
the specified type of data structure should be allocated.  The argument
<TT>&quot;type&quot;</TT> is passed to <TT>&quot;sizeof&quot;</TT>.  The final argument to <TT>&quot;Newc&quot;</TT>, <TT>&quot;cast&quot;</TT>,
should be used if the <TT>&quot;pointer&quot;</TT> argument is different from the <TT>&quot;type&quot;</TT>
argument.
<P>

Unlike the <TT>&quot;New&quot;</TT> and <TT>&quot;Newc&quot;</TT> macros, the <TT>&quot;Newz&quot;</TT> macro calls <TT>&quot;memzero&quot;</TT>
to zero out all the newly allocated memory.
<P>

<I>Reallocation</I>
<A NAME="ixACD"></A>
<P>



<PRE>
    Renew(pointer, number, type);
    Renewc(pointer, number, type, cast);
    Safefree(pointer)

</PRE>


<P>

These three macros are used to change a memory buffer size or to free a
piece of memory no longer needed.  The arguments to <TT>&quot;Renew&quot;</TT> and <TT>&quot;Renewc&quot;</TT>
match those of <TT>&quot;New&quot;</TT> and <TT>&quot;Newc&quot;</TT> with the exception of not needing the
``magic cookie'' argument.
<P>

<I>Moving</I>
<A NAME="ixACE"></A>
<P>



<PRE>
    Move(source, dest, number, type);
    Copy(source, dest, number, type);
    Zero(dest, number, type);

</PRE>


<P>

These three macros are used to move, copy, or zero out previously allocated
memory.  The <TT>&quot;source&quot;</TT> and <TT>&quot;dest&quot;</TT> arguments point to the source and
destination starting points.  Perl will move, copy, or zero out <TT>&quot;number&quot;</TT>
instances of the size of the <TT>&quot;type&quot;</TT> data structure (using the <TT>&quot;sizeof&quot;</TT>
function).
<A NAME="lbBD">&nbsp;</A>
<H2>PerlIO</H2>

<A NAME="ixACF"></A>
The most recent development releases of Perl has been experimenting with
removing Perl's dependency on the ``normal'' standard I/O suite and allowing
other stdio implementations to be used.  This involves creating a new
abstraction layer that then calls whichever implementation of stdio Perl
was compiled with.  All XSUBs should now use the functions in the PerlIO
abstraction layer and not make any assumptions about what kind of stdio
is being used.
<P>

For a complete description of the PerlIO abstraction, consult perlapio.
<A NAME="lbBE">&nbsp;</A>
<H2>Putting a C value on Perl stack</H2>

<A NAME="ixACG"></A>
A lot of opcodes (this is an elementary operation in the internal perl
stack machine) put an SV* on the stack. However, as an optimization
the corresponding <FONT SIZE="-1">SV</FONT> is (usually) not recreated each time. The opcodes
reuse specially assigned SVs (<I>target</I>s) which are (as a corollary)
not constantly freed/created.
<P>

Each of the targets is created only once (but see
``Scratchpads and recursion'' below), and when an opcode needs to put
an integer, a double, or a string on stack, it just sets the
corresponding parts of its <I>target</I> and puts the <I>target</I> on stack.
<P>

The macro to put this target on stack is <TT>&quot;PUSHTARG&quot;</TT>, and it is
directly used in some opcodes, as well as indirectly in zillions of
others, which use it via <TT>&quot;(X)PUSH[iunp]&quot;</TT>.
<P>

Because the target is reused, you must be careful when pushing multiple
values on the stack. The following code will not do what you think:
<P>



<PRE>
    XPUSHi(10);
    XPUSHi(20);

</PRE>


<P>

This translates as &quot;set <TT>&quot;TARG&quot;</TT> to 10, push a pointer to <TT>&quot;TARG&quot;</TT> onto
the stack; set <TT>&quot;TARG&quot;</TT> to 20, push a pointer to <TT>&quot;TARG&quot;</TT> onto the stack&quot;.
At the end of the operation, the stack does not contain the values 10
and 20, but actually contains two pointers to <TT>&quot;TARG&quot;</TT>, which we have set
to 20.
<P>

If you need to push multiple different values then you should either use
the <TT>&quot;(X)PUSHs&quot;</TT> macros, or else use the new <TT>&quot;m(X)PUSH[iunp]&quot;</TT> macros,
none of which make use of <TT>&quot;TARG&quot;</TT>.  The <TT>&quot;(X)PUSHs&quot;</TT> macros simply push an
SV* on the stack, which, as noted under ``XSUBs and the Argument Stack'',
will often need to be ``mortal''.  The new <TT>&quot;m(X)PUSH[iunp]&quot;</TT> macros make
this a little easier to achieve by creating a new mortal for you (via
<TT>&quot;(X)PUSHmortal&quot;</TT>), pushing that onto the stack (extending it if necessary
in the case of the <TT>&quot;mXPUSH[iunp]&quot;</TT> macros), and then setting its value.
Thus, instead of writing this to ``fix'' the example above:
<P>



<PRE>
    XPUSHs(sv_2mortal(newSViv(10)))
    XPUSHs(sv_2mortal(newSViv(20)))

</PRE>


<P>

you can simply write:
<P>



<PRE>
    mXPUSHi(10)
    mXPUSHi(20)

</PRE>


<P>

On a related note, if you do use <TT>&quot;(X)PUSH[iunp]&quot;</TT>, then you're going to
need a <TT>&quot;dTARG&quot;</TT> in your variable declarations so that the <TT>&quot;*PUSH*&quot;</TT>
macros can make use of the local variable <TT>&quot;TARG&quot;</TT>.  See also <TT>&quot;dTARGET&quot;</TT>
and <TT>&quot;dXSTARG&quot;</TT>.
<A NAME="lbBF">&nbsp;</A>
<H2>Scratchpads</H2>

<A NAME="ixACH"></A>
The question remains on when the SVs which are <I>target</I>s for opcodes
are created. The answer is that they are created when the current unit ---
a subroutine or a file (for opcodes for statements outside of
subroutines) --- is compiled. During this time a special anonymous Perl
array is created, which is called a scratchpad for the current
unit.
<P>

A scratchpad keeps SVs which are lexicals for the current unit and are
targets for opcodes. One can deduce that an <FONT SIZE="-1">SV</FONT> lives on a scratchpad
by looking on its flags: lexicals have <TT>&quot;SVs_PADMY&quot;</TT> set, and
<I>target</I>s have <TT>&quot;SVs_PADTMP&quot;</TT> set.
<P>

The correspondence between OPs and <I>target</I>s is not 1-to-1. Different
OPs in the compile tree of the unit can use the same target, if this
would not conflict with the expected life of the temporary.
<A NAME="lbBG">&nbsp;</A>
<H2>Scratchpads and recursion</H2>

<A NAME="ixACI"></A>
In fact it is not 100% true that a compiled unit contains a pointer to
the scratchpad <FONT SIZE="-1">AV</FONT>. In fact it contains a pointer to an <FONT SIZE="-1">AV</FONT> of
(initially) one element, and this element is the scratchpad <FONT SIZE="-1">AV</FONT>. Why do
we need an extra level of indirection?
<P>

The answer is <B>recursion</B>, and maybe <B>threads</B>. Both
these can create several execution pointers going into the same
subroutine. For the subroutine-child not write over the temporaries
for the subroutine-parent (lifespan of which covers the call to the
child), the parent and the child should have different
scratchpads. (<I>And</I> the lexicals should be separate anyway!)
<P>

So each subroutine is born with an array of scratchpads (of length 1).
On each entry to the subroutine it is checked that the current
depth of the recursion is not more than the length of this array, and
if it is, new scratchpad is created and pushed into the array.
<P>

The <I>target</I>s on this scratchpad are <TT>&quot;undef&quot;</TT>s, but they are already
marked with correct flags.
<A NAME="lbBH">&nbsp;</A>
<H2>Compiled code</H2>

<A NAME="ixACJ"></A>
<A NAME="lbBI">&nbsp;</A>
<H2>Code tree</H2>

<A NAME="ixACK"></A>
Here we describe the internal form your code is converted to by
Perl. Start with a simple example:
<P>



<PRE>
  $a = $b + $c;

</PRE>


<P>

This is converted to a tree similar to this one:
<P>



<PRE>
             assign-to
           /           \
          +             $a
        /   \
      $b     $c

</PRE>


<P>

(but slightly more complicated).  This tree reflects the way Perl
parsed your code, but has nothing to do with the execution order.
There is an additional ``thread'' going through the nodes of the tree
which shows the order of execution of the nodes.  In our simplified
example above it looks like:
<P>



<PRE>
     $b ---&gt; $c ---&gt; + ---&gt; $a ---&gt; assign-to

</PRE>


<P>

But with the actual compile tree for <TT>&quot;$a = $b + $c&quot;</TT> it is different:
some nodes <I>optimized away</I>.  As a corollary, though the actual tree
contains more nodes than our simplified example, the execution order
is the same as in our example.
<A NAME="lbBJ">&nbsp;</A>
<H2>Examining the tree</H2>

<A NAME="ixACL"></A>
If you have your perl compiled for debugging (usually done with
<TT>&quot;-DDEBUGGING&quot;</TT> on the <TT>&quot;Configure&quot;</TT> command line), you may examine the
compiled tree by specifying <TT>&quot;-Dx&quot;</TT> on the Perl command line.  The
output takes several lines per node, and for <TT>&quot;$b+$c&quot;</TT> it looks like
this:
<P>



<PRE>
    5           TYPE = add  ===&gt; 6
                TARG = 1
                FLAGS = (SCALAR,KIDS)
                {
                    TYPE = null  ===&gt; (4)
                      (was rv2sv)
                    FLAGS = (SCALAR,KIDS)
                    {
    3                   TYPE = gvsv  ===&gt; 4
                        FLAGS = (SCALAR)
                        GV = main::b
                    }
                }
                {
                    TYPE = null  ===&gt; (5)
                      (was rv2sv)
                    FLAGS = (SCALAR,KIDS)
                    {
    4                   TYPE = gvsv  ===&gt; 5
                        FLAGS = (SCALAR)
                        GV = main::c
                    }
                }

</PRE>


<P>

This tree has 5 nodes (one per <TT>&quot;TYPE&quot;</TT> specifier), only 3 of them are
not optimized away (one per number in the left column).  The immediate
children of the given node correspond to <TT>&quot;{}&quot;</TT> pairs on the same level
of indentation, thus this listing corresponds to the tree:
<P>



<PRE>
                   add
                 /     \
               null    null
                |       |
               gvsv    gvsv

</PRE>


<P>

The execution order is indicated by <TT>&quot;===&gt;&quot;</TT> marks, thus it is <TT>&quot;3
4 5 6&quot;</TT> (node <TT>6</TT> is not included into above listing), i.e.,
<TT>&quot;gvsv gvsv add whatever&quot;</TT>.
<P>

Each of these nodes represents an op, a fundamental operation inside the
Perl core. The code which implements each operation can be found in the
<I>pp*.c</I> files; the function which implements the op with type <TT>&quot;gvsv&quot;</TT>
is <TT>&quot;pp_gvsv&quot;</TT>, and so on. As the tree above shows, different ops have
different numbers of children: <TT>&quot;add&quot;</TT> is a binary operator, as one would
expect, and so has two children. To accommodate the various different
numbers of children, there are various types of op data structure, and
they link together in different ways.
<P>

The simplest type of op structure is <TT>&quot;OP&quot;</TT>: this has no children. Unary
operators, <TT>&quot;UNOP&quot;</TT>s, have one child, and this is pointed to by the
<TT>&quot;op_first&quot;</TT> field. Binary operators (<TT>&quot;BINOP&quot;</TT>s) have not only an
<TT>&quot;op_first&quot;</TT> field but also an <TT>&quot;op_last&quot;</TT> field. The most complex type of
op is a <TT>&quot;LISTOP&quot;</TT>, which has any number of children. In this case, the
first child is pointed to by <TT>&quot;op_first&quot;</TT> and the last child by
<TT>&quot;op_last&quot;</TT>. The children in between can be found by iteratively
following the <TT>&quot;op_sibling&quot;</TT> pointer from the first child to the last.
<P>

There are also two other op types: a <TT>&quot;PMOP&quot;</TT> holds a regular expression,
and has no children, and a <TT>&quot;LOOP&quot;</TT> may or may not have children. If the
<TT>&quot;op_children&quot;</TT> field is non-zero, it behaves like a <TT>&quot;LISTOP&quot;</TT>. To
complicate matters, if a <TT>&quot;UNOP&quot;</TT> is actually a <TT>&quot;null&quot;</TT> op after
optimization (see ``Compile pass 2: context propagation'') it will still
have children in accordance with its former type.
<P>

Another way to examine the tree is to use a compiler back-end module, such
as B::Concise.
<A NAME="lbBK">&nbsp;</A>
<H2>Compile pass 1: check routines</H2>

<A NAME="ixACM"></A>
The tree is created by the compiler while <I>yacc</I> code feeds it
the constructions it recognizes. Since <I>yacc</I> works bottom-up, so does
the first pass of perl compilation.
<P>

What makes this pass interesting for perl developers is that some
optimization may be performed on this pass.  This is optimization by
so-called ``check routines''.  The correspondence between node names
and corresponding check routines is described in <I>opcode.pl</I> (do not
forget to run <TT>&quot;make regen_headers&quot;</TT> if you modify this file).
<P>

A check routine is called when the node is fully constructed except
for the execution-order thread.  Since at this time there are no
back-links to the currently constructed node, one can do most any
operation to the top-level node, including freeing it and/or creating
new nodes above/below it.
<P>

The check routine returns the node which should be inserted into the
tree (if the top-level node was not modified, check routine returns
its argument).
<P>

By convention, check routines have names <TT>&quot;ck_*&quot;</TT>. They are usually
called from <TT>&quot;new*OP&quot;</TT> subroutines (or <TT>&quot;convert&quot;</TT>) (which in turn are
called from <I>perly.y</I>).
<A NAME="lbBL">&nbsp;</A>
<H2>Compile pass 1a: constant folding</H2>

<A NAME="ixACN"></A>
Immediately after the check routine is called the returned node is
checked for being compile-time executable.  If it is (the value is
judged to be constant) it is immediately executed, and a <I>constant</I>
node with the ``return value'' of the corresponding subtree is
substituted instead.  The subtree is deleted.
<P>

If constant folding was not performed, the execution-order thread is
created.
<A NAME="lbBM">&nbsp;</A>
<H2>Compile pass 2: context propagation</H2>

<A NAME="ixACO"></A>
When a context for a part of compile tree is known, it is propagated
down through the tree.  At this time the context can have 5 values
(instead of 2 for runtime context): void, boolean, scalar, list, and
lvalue.  In contrast with the pass 1 this pass is processed from top
to bottom: a node's context determines the context for its children.
<P>

Additional context-dependent optimizations are performed at this time.
Since at this moment the compile tree contains back-references (via
``thread'' pointers), nodes cannot be <I>free()</I>d now.  To allow
optimized-away nodes at this stage, such nodes are <I>null()</I>ified instead
of <I>free()</I>ing (i.e. their type is changed to <FONT SIZE="-1">OP_NULL</FONT>).
<A NAME="lbBN">&nbsp;</A>
<H2>Compile pass 3: peephole optimization</H2>

<A NAME="ixACP"></A>
After the compile tree for a subroutine (or for an <TT>&quot;eval&quot;</TT> or a file)
is created, an additional pass over the code is performed. This pass
is neither top-down or bottom-up, but in the execution order (with
additional complications for conditionals).  These optimizations are
done in the subroutine <I>peep()</I>.  Optimizations performed at this stage
are subject to the same restrictions as in the pass 2.
<A NAME="lbBO">&nbsp;</A>
<H2>Pluggable runops</H2>

<A NAME="ixACQ"></A>
The compile tree is executed in a runops function.  There are two runops
functions, in <I>run.c</I> and in <I>dump.c</I>.  <TT>&quot;Perl_runops_debug&quot;</TT> is used
with <FONT SIZE="-1">DEBUGGING</FONT> and <TT>&quot;Perl_runops_standard&quot;</TT> is used otherwise.  For fine
control over the execution of the compile tree it is possible to provide
your own runops function.
<P>

It's probably best to copy one of the existing runops functions and
change it to suit your needs.  Then, in the <FONT SIZE="-1">BOOT</FONT> section of your <FONT SIZE="-1">XS</FONT>
file, add the line:
<P>



<PRE>
  PL_runops = my_runops;

</PRE>


<P>

This function should be as efficient as possible to keep your programs
running as fast as possible.
<A NAME="lbBP">&nbsp;</A>
<H2>Examining internal data structures with the dump functions</H2>



<A NAME="ixACR"></A>
To aid debugging, the source file <I>dump.c</I> contains a number of
functions which produce formatted output of internal data structures.
<P>

The most commonly used of these functions is <TT>&quot;Perl_sv_dump&quot;</TT>; it's used
for dumping SVs, AVs, HVs, and CVs. The <TT>&quot;Devel::Peek&quot;</TT> module calls
<TT>&quot;sv_dump&quot;</TT> to produce debugging output from Perl-space, so users of that
module should already be familiar with its format.
<P>

<TT>&quot;Perl_op_dump&quot;</TT> can be used to dump an <TT>&quot;OP&quot;</TT> structure or any of its
derivatives, and produces output similar to <TT>&quot;perl -Dx&quot;</TT>; in fact,
<TT>&quot;Perl_dump_eval&quot;</TT> will dump the main root of the code being evaluated,
exactly like <TT>&quot;-Dx&quot;</TT>.
<P>

Other useful functions are <TT>&quot;Perl_dump_sub&quot;</TT>, which turns a <TT>&quot;GV&quot;</TT> into an
op tree, <TT>&quot;Perl_dump_packsubs&quot;</TT> which calls <TT>&quot;Perl_dump_sub&quot;</TT> on all the
subroutines in a package like so: (Thankfully, these are all xsubs, so
there is no op tree)
<P>



<PRE>
    (gdb) print Perl_dump_packsubs(PL_defstash)

</PRE>


<P>



<PRE>
    SUB attributes::bootstrap = (xsub 0x811fedc 0)

</PRE>


<P>



<PRE>
    SUB UNIVERSAL::can = (xsub 0x811f50c 0)

</PRE>


<P>



<PRE>
    SUB UNIVERSAL::isa = (xsub 0x811f304 0)

</PRE>


<P>



<PRE>
    SUB UNIVERSAL::VERSION = (xsub 0x811f7ac 0)

</PRE>


<P>



<PRE>
    SUB DynaLoader::boot_DynaLoader = (xsub 0x805b188 0)

</PRE>


<P>

and <TT>&quot;Perl_dump_all&quot;</TT>, which dumps all the subroutines in the stash and
the op tree of the main root.
<A NAME="lbBQ">&nbsp;</A>
<H2>How multiple interpreters and concurrency are supported</H2>

<A NAME="ixACS"></A>
<A NAME="lbBR">&nbsp;</A>
<H2>Background and <FONT SIZE="-1">PERL_IMPLICIT_CONTEXT</FONT></H2>

<A NAME="ixACT"></A>
The Perl interpreter can be regarded as a closed box: it has an <FONT SIZE="-1">API</FONT>
for feeding it code or otherwise making it do things, but it also has
functions for its own use.  This smells a lot like an object, and
there are ways for you to build Perl so that you can have multiple
interpreters, with one interpreter represented either as a C structure,
or inside a thread-specific structure.  These structures contain all
the context, the state of that interpreter.
<P>

Two macros control the major Perl build flavors: <FONT SIZE="-1">MULTIPLICITY</FONT> and
<FONT SIZE="-1">USE_5005THREADS</FONT>.  The <FONT SIZE="-1">MULTIPLICITY</FONT> build has a C structure
that packages all the interpreter state, and there is a similar thread-specific
data structure under <FONT SIZE="-1">USE_5005THREADS</FONT>.  In both cases,
<FONT SIZE="-1">PERL_IMPLICIT_CONTEXT</FONT> is also normally defined, and enables the
support for passing in a ``hidden'' first argument that represents all three
data structures.
<P>

All this obviously requires a way for the Perl internal functions to be
either subroutines taking some kind of structure as the first
argument, or subroutines taking nothing as the first argument.  To
enable these two very different ways of building the interpreter,
the Perl source (as it does in so many other situations) makes heavy
use of macros and subroutine naming conventions.
<P>

First problem: deciding which functions will be public <FONT SIZE="-1">API</FONT> functions and
which will be private.  All functions whose names begin <TT>&quot;S_&quot;</TT> are private
(think ``S'' for ``secret'' or ``static'').  All other functions begin with
``Perl_'', but just because a function begins with ``Perl_'' does not mean it is
part of the <FONT SIZE="-1">API</FONT>. (See ``Internal Functions''.) The easiest way to be <B>sure</B> a
function is part of the <FONT SIZE="-1">API</FONT> is to find its entry in perlapi.
If it exists in perlapi, it's part of the <FONT SIZE="-1">API</FONT>.  If it doesn't, and you
think it should be (i.e., you need it for your extension), send mail via
perlbug explaining why you think it should be.
<P>

Second problem: there must be a syntax so that the same subroutine
declarations and calls can pass a structure as their first argument,
or pass nothing.  To solve this, the subroutines are named and
declared in a particular way.  Here's a typical start of a static
function used within the Perl guts:
<P>



<PRE>
  STATIC void
  S_incline(pTHX_ char *s)

</PRE>


<P>

<FONT SIZE="-1">STATIC</FONT> becomes ``static'' in C, and may be #define'd to nothing in some
configurations in future.
<P>

A public function (i.e. part of the internal <FONT SIZE="-1">API</FONT>, but not necessarily
sanctioned for use in extensions) begins like this:
<P>



<PRE>
  void
  Perl_sv_setiv(pTHX_ SV* dsv, IV num)

</PRE>


<P>

<TT>&quot;pTHX_&quot;</TT> is one of a number of macros (in perl.h) that hide the
details of the interpreter's context.  <FONT SIZE="-1">THX</FONT> stands for ``thread'', ``this'',
or ``thingy'', as the case may be.  (And no, George Lucas is not involved. :-)
The first character could be 'p' for a <B>p</B>rototype, 'a' for <B>a</B>rgument,
or 'd' for <B>d</B>eclaration, so we have <TT>&quot;pTHX&quot;</TT>, <TT>&quot;aTHX&quot;</TT> and <TT>&quot;dTHX&quot;</TT>, and
their variants.
<P>

When Perl is built without options that set <FONT SIZE="-1">PERL_IMPLICIT_CONTEXT</FONT>, there is no
first argument containing the interpreter's context.  The trailing underscore
in the pTHX_ macro indicates that the macro expansion needs a comma
after the context argument because other arguments follow it.  If
<FONT SIZE="-1">PERL_IMPLICIT_CONTEXT</FONT> is not defined, pTHX_ will be ignored, and the
subroutine is not prototyped to take the extra argument.  The form of the
macro without the trailing underscore is used when there are no additional
explicit arguments.
<P>

When a core function calls another, it must pass the context.  This
is normally hidden via macros.  Consider <TT>&quot;sv_setiv&quot;</TT>.  It expands into
something like this:
<P>



<PRE>
    #ifdef PERL_IMPLICIT_CONTEXT
      #define sv_setiv(a,b)      Perl_sv_setiv(aTHX_ a, b)
      /* can't do this for vararg functions, see below */
    #else
      #define sv_setiv           Perl_sv_setiv
    #endif

</PRE>


<P>

This works well, and means that <FONT SIZE="-1">XS</FONT> authors can gleefully write:
<P>



<PRE>
    sv_setiv(foo, bar);

</PRE>


<P>

and still have it work under all the modes Perl could have been
compiled with.
<P>

This doesn't work so cleanly for varargs functions, though, as macros
imply that the number of arguments is known in advance.  Instead we
either need to spell them out fully, passing <TT>&quot;aTHX_&quot;</TT> as the first
argument (the Perl core tends to do this with functions like
Perl_warner), or use a context-free version.
<P>

The context-free version of Perl_warner is called
Perl_warner_nocontext, and does not take the extra argument.  Instead
it does dTHX; to get the context from thread-local storage.  We
<TT>&quot;#define warner Perl_warner_nocontext&quot;</TT> so that extensions get source
compatibility at the expense of performance.  (Passing an arg is
cheaper than grabbing it from thread-local storage.)
<P>

You can ignore [pad]THXx when browsing the Perl headers/sources.
Those are strictly for use within the core.  Extensions and embedders
need only be aware of [pad]THX.
<A NAME="lbBS">&nbsp;</A>
<H2>So what happened to dTHR?

</H2>

<A NAME="ixACU"></A>
<TT>&quot;dTHR&quot;</TT> was introduced in perl 5.005 to support the older thread model.
The older thread model now uses the <TT>&quot;THX&quot;</TT> mechanism to pass context
pointers around, so <TT>&quot;dTHR&quot;</TT> is not useful any more.  Perl 5.6.0 and
later still have it for backward source compatibility, but it is defined
to be a no-op.
<A NAME="lbBT">&nbsp;</A>
<H2>How do I use all this in extensions?</H2>

<A NAME="ixACV"></A>
When Perl is built with <FONT SIZE="-1">PERL_IMPLICIT_CONTEXT</FONT>, extensions that call
any functions in the Perl <FONT SIZE="-1">API</FONT> will need to pass the initial context
argument somehow.  The kicker is that you will need to write it in
such a way that the extension still compiles when Perl hasn't been
built with <FONT SIZE="-1">PERL_IMPLICIT_CONTEXT</FONT> enabled.
<P>

There are three ways to do this.  First, the easy but inefficient way,
which is also the default, in order to maintain source compatibility
with extensions: whenever <FONT SIZE="-1">XSUB</FONT>.h is #included, it redefines the aTHX
and aTHX_ macros to call a function that will return the context.
Thus, something like:
<P>



<PRE>
        sv_setiv(sv, num);

</PRE>


<P>

in your extension will translate to this when <FONT SIZE="-1">PERL_IMPLICIT_CONTEXT</FONT> is
in effect:
<P>



<PRE>
        Perl_sv_setiv(Perl_get_context(), sv, num);

</PRE>


<P>

or to this otherwise:
<P>



<PRE>
        Perl_sv_setiv(sv, num);

</PRE>


<P>

You have to do nothing new in your extension to get this; since
the Perl library provides <I>Perl_get_context()</I>, it will all just
work.
<P>

The second, more efficient way is to use the following template for
your Foo.xs:
<P>



<PRE>
        #define PERL_NO_GET_CONTEXT     /* we want efficiency */
        #include &quot;EXTERN.h&quot;
        #include &quot;perl.h&quot;
        #include &quot;XSUB.h&quot;

</PRE>


<P>



<PRE>
        static my_private_function(int arg1, int arg2);

</PRE>


<P>



<PRE>
        static SV *
        my_private_function(int arg1, int arg2)
        {
            dTHX;       /* fetch context */
            ... call many Perl API functions ...
        }

</PRE>


<P>



<PRE>
        [... etc ...]

</PRE>


<P>



<PRE>
        MODULE = Foo            PACKAGE = Foo

</PRE>


<P>



<PRE>
        /* typical XSUB */

</PRE>


<P>



<PRE>
        void
        my_xsub(arg)
                int arg
            CODE:
                my_private_function(arg, 10);

</PRE>


<P>

Note that the only two changes from the normal way of writing an
extension is the addition of a <TT>&quot;#define PERL_NO_GET_CONTEXT&quot;</TT> before
including the Perl headers, followed by a <TT>&quot;dTHX;&quot;</TT> declaration at
the start of every function that will call the Perl <FONT SIZE="-1">API</FONT>.  (You'll
know which functions need this, because the C compiler will complain
that there's an undeclared identifier in those functions.)  No changes
are needed for the XSUBs themselves, because the <FONT SIZE="-1"><I>XS</I></FONT><I>()</I> macro is
correctly defined to pass in the implicit context if needed.
<P>

The third, even more efficient way is to ape how it is done within
the Perl guts:
<P>



<PRE>
        #define PERL_NO_GET_CONTEXT     /* we want efficiency */
        #include &quot;EXTERN.h&quot;
        #include &quot;perl.h&quot;
        #include &quot;XSUB.h&quot;

</PRE>


<P>



<PRE>
        /* pTHX_ only needed for functions that call Perl API */
        static my_private_function(pTHX_ int arg1, int arg2);

</PRE>


<P>



<PRE>
        static SV *
        my_private_function(pTHX_ int arg1, int arg2)
        {
            /* dTHX; not needed here, because THX is an argument */
            ... call Perl API functions ...
        }

</PRE>


<P>



<PRE>
        [... etc ...]

</PRE>


<P>



<PRE>
        MODULE = Foo            PACKAGE = Foo

</PRE>


<P>



<PRE>
        /* typical XSUB */

</PRE>


<P>



<PRE>
        void
        my_xsub(arg)
                int arg
            CODE:
                my_private_function(aTHX_ arg, 10);

</PRE>


<P>

This implementation never has to fetch the context using a function
call, since it is always passed as an extra argument.  Depending on
your needs for simplicity or efficiency, you may mix the previous
two approaches freely.
<P>

Never add a comma after <TT>&quot;pTHX&quot;</TT> yourself---always use the form of the
macro with the underscore for functions that take explicit arguments,
or the form without the argument for functions with no explicit arguments.
<A NAME="lbBU">&nbsp;</A>
<H2>Should I do anything special if I call perl from multiple threads?</H2>

<A NAME="ixACW"></A>
If you create interpreters in one thread and then proceed to call them in
another, you need to make sure perl's own Thread Local Storage (<FONT SIZE="-1">TLS</FONT>) slot is
initialized correctly in each of those threads.
<P>

The <TT>&quot;perl_alloc&quot;</TT> and <TT>&quot;perl_clone&quot;</TT> <FONT SIZE="-1">API</FONT> functions will automatically set
the <FONT SIZE="-1">TLS</FONT> slot to the interpreter they created, so that there is no need to do
anything special if the interpreter is always accessed in the same thread that
created it, and that thread did not create or call any other interpreters
afterwards.  If that is not the case, you have to set the <FONT SIZE="-1">TLS</FONT> slot of the
thread before calling any functions in the Perl <FONT SIZE="-1">API</FONT> on that particular
interpreter.  This is done by calling the <TT>&quot;PERL_SET_CONTEXT&quot;</TT> macro in that
thread as the first thing you do:
<P>



<PRE>
        /* do this before doing anything else with some_perl */
        PERL_SET_CONTEXT(some_perl);

</PRE>


<P>



<PRE>
        ... other Perl API calls on some_perl go here ...

</PRE>


<A NAME="lbBV">&nbsp;</A>
<H2>Future Plans and <FONT SIZE="-1">PERL_IMPLICIT_SYS</FONT></H2>

<A NAME="ixACX"></A>
Just as <FONT SIZE="-1">PERL_IMPLICIT_CONTEXT</FONT> provides a way to bundle up everything
that the interpreter knows about itself and pass it around, so too are
there plans to allow the interpreter to bundle up everything it knows
about the environment it's running on.  This is enabled with the
<FONT SIZE="-1">PERL_IMPLICIT_SYS</FONT> macro.  Currently it only works with <FONT SIZE="-1">USE_ITHREADS</FONT>
and <FONT SIZE="-1">USE_5005THREADS</FONT> on Windows (see inside iperlsys.h).
<P>

This allows the ability to provide an extra pointer (called the ``host''
environment) for all the system calls.  This makes it possible for
all the system stuff to maintain their own state, broken down into
seven C structures.  These are thin wrappers around the usual system
calls (see win32/perllib.c) for the default perl executable, but for a
more ambitious host (like the one that would do <I>fork()</I> emulation) all
the extra work needed to pretend that different interpreters are
actually different ``processes'', would be done here.
<P>

The Perl engine/interpreter and the host are orthogonal entities.
There could be one or more interpreters in a process, and one or
more ``hosts'', with free association between them.
<A NAME="lbBW">&nbsp;</A>
<H2>Internal Functions</H2>

<A NAME="ixACY"></A>
All of Perl's internal functions which will be exposed to the outside
world are prefixed by <TT>&quot;Perl_&quot;</TT> so that they will not conflict with <FONT SIZE="-1">XS</FONT>
functions or functions used in a program in which Perl is embedded.
Similarly, all global variables begin with <TT>&quot;PL_&quot;</TT>. (By convention,
static functions start with <TT>&quot;S_&quot;</TT>.)
<P>

Inside the Perl core, you can get at the functions either with or
without the <TT>&quot;Perl_&quot;</TT> prefix, thanks to a bunch of defines that live in
<I>embed.h</I>. This header file is generated automatically from
<I>embed.pl</I> and <I>embed.fnc</I>. <I>embed.pl</I> also creates the prototyping
header files for the internal functions, generates the documentation
and a lot of other bits and pieces. It's important that when you add
a new function to the core or change an existing one, you change the
data in the table in <I>embed.fnc</I> as well. Here's a sample entry from
that table:
<P>



<PRE>
    Apd |SV**   |av_fetch   |AV* ar|I32 key|I32 lval

</PRE>


<P>

The second column is the return type, the third column the name. Columns
after that are the arguments. The first column is a set of flags:
<DL COMPACT>
<DT>A<DD>
<A NAME="ixACZ"></A>
This function is a part of the public <FONT SIZE="-1">API</FONT>.
<DT>p<DD>
<A NAME="ixADA"></A>
This function has a <TT>&quot;Perl_&quot;</TT> prefix; ie, it is defined as <TT>&quot;Perl_av_fetch&quot;</TT>
<DT>d<DD>
<A NAME="ixADB"></A>
This function has documentation using the <TT>&quot;apidoc&quot;</TT> feature which we'll
look at in a second.
</DL>
<P>

Other available flags are:
<DL COMPACT>
<DT>s<DD>
<A NAME="ixADC"></A>
This is a static function and is defined as <TT>&quot;S_whatever&quot;</TT>, and usually
called within the sources as <TT>&quot;whatever(...)&quot;</TT>.
<DT>n<DD>
<A NAME="ixADD"></A>
This does not use <TT>&quot;aTHX_&quot;</TT> and <TT>&quot;pTHX&quot;</TT> to pass interpreter context. (See
``Background and <FONT SIZE="-1">PERL_IMPLICIT_CONTEXT</FONT>'' in perlguts.)
<DT>r<DD>
<A NAME="ixADE"></A>
This function never returns; <TT>&quot;croak&quot;</TT>, <TT>&quot;exit&quot;</TT> and friends.
<DT>f<DD>
<A NAME="ixADF"></A>
This function takes a variable number of arguments, <TT>&quot;printf&quot;</TT> style.
The argument list should end with <TT>&quot;...&quot;</TT>, like this:


<P>




<PRE>
    Afprd   |void   |croak          |const char* pat|...

</PRE>


<DT>M<DD>
<A NAME="ixADG"></A>
This function is part of the experimental development <FONT SIZE="-1">API</FONT>, and may change
or disappear without notice.
<DT>o<DD>
This function should not have a compatibility macro to define, say,
<TT>&quot;Perl_parse&quot;</TT> to <TT>&quot;parse&quot;</TT>. It must be called as <TT>&quot;Perl_parse&quot;</TT>.
<DT>x<DD>
<A NAME="ixADH"></A>
This function isn't exported out of the Perl core.
<DT>m<DD>
<A NAME="ixADI"></A>
This is implemented as a macro.
<DT>X<DD>
<A NAME="ixADJ"></A>
This function is explicitly exported.
<DT>E<DD>
<A NAME="ixADK"></A>
This function is visible to extensions included in the Perl core.
<DT>b<DD>
<A NAME="ixADL"></A>
Binary backward compatibility; this function is a macro but also has
a <TT>&quot;Perl_&quot;</TT> implementation (which is exported).
</DL>
<P>

If you edit <I>embed.pl</I> or <I>embed.fnc</I>, you will need to run
<TT>&quot;make regen_headers&quot;</TT> to force a rebuild of <I>embed.h</I> and other
auto-generated files.
<A NAME="lbBX">&nbsp;</A>
<H2>Formatted Printing of IVs, UVs, and NVs</H2>

<A NAME="ixADM"></A>
If you are printing IVs, UVs, or <FONT SIZE="-1">NVS</FONT> instead of the <I><A HREF="../man3/stdio.3.php">stdio</A></I>(3) style
formatting codes like <TT>%d</TT>, <TT>%ld</TT>, <TT>%f</TT>, you should use the
following macros for portability
<P>



<PRE>
        IVdf            IV in decimal
        UVuf            UV in decimal
        UVof            UV in octal
        UVxf            UV in hexadecimal
        NVef            NV %e-like
        NVff            NV %f-like
        NVgf            NV %g-like

</PRE>


<P>

These will take care of 64-bit integers and long doubles.
For example:
<P>



<PRE>
        printf(&quot;IV is %&quot;IVdf&quot;\n&quot;, iv);

</PRE>


<P>

The IVdf will expand to whatever is the correct format for the IVs.
<P>

If you are printing addresses of pointers, use UVxf combined
with <FONT SIZE="-1"><I>PTR2UV</I></FONT><I>()</I>, do not use <TT>%lx</TT> or <TT>%p</TT>.
<A NAME="lbBY">&nbsp;</A>
<H2>Pointer-To-Integer and Integer-To-Pointer</H2>

<A NAME="ixADN"></A>
Because pointer size does not necessarily equal integer size,
use the follow macros to do it right.
<P>



<PRE>
        PTR2UV(pointer)
        PTR2IV(pointer)
        PTR2NV(pointer)
        INT2PTR(pointertotype, integer)

</PRE>


<P>

For example:
<P>



<PRE>
        IV  iv = ...;
        SV *sv = INT2PTR(SV*, iv);

</PRE>


<P>

and
<P>



<PRE>
        AV *av = ...;
        UV  uv = PTR2UV(av);

</PRE>


<A NAME="lbBZ">&nbsp;</A>
<H2>Source Documentation</H2>

<A NAME="ixADO"></A>
There's an effort going on to document the internal functions and
automatically produce reference manuals from them - perlapi is one
such manual which details all the functions which are available to <FONT SIZE="-1">XS</FONT>
writers. perlintern is the autogenerated manual for the functions
which are not part of the <FONT SIZE="-1">API</FONT> and are supposedly for internal use only.
<P>

Source documentation is created by putting <FONT SIZE="-1">POD</FONT> comments into the C
source, like this:
<P>



<PRE>
 /*
 =for apidoc sv_setiv

</PRE>


<P>



<PRE>
 Copies an integer into the given SV.  Does not handle 'set' magic.  See
 C&lt;sv_setiv_mg&gt;.

</PRE>


<P>



<PRE>
 =cut
 */

</PRE>


<P>

Please try and supply some documentation if you add functions to the
Perl core.
<A NAME="lbCA">&nbsp;</A>
<H2>Unicode Support</H2>

<A NAME="ixADP"></A>
Perl 5.6.0 introduced Unicode support. It's important for porters and <FONT SIZE="-1">XS</FONT>
writers to understand this support and make sure that the code they
write does not corrupt Unicode data.
<A NAME="lbCB">&nbsp;</A>
<H2>What <B>is</B> Unicode, anyway?</H2>

<A NAME="ixADQ"></A>
In the olden, less enlightened times, we all used to use <FONT SIZE="-1">ASCII</FONT>. Most of
us did, anyway. The big problem with <FONT SIZE="-1">ASCII</FONT> is that it's American. Well,
no, that's not actually the problem; the problem is that it's not
particularly useful for people who don't use the Roman alphabet. What
used to happen was that particular languages would stick their own
alphabet in the upper range of the sequence, between 128 and 255. Of
course, we then ended up with plenty of variants that weren't quite
<FONT SIZE="-1">ASCII</FONT>, and the whole point of it being a standard was lost.
<P>

Worse still, if you've got a language like Chinese or
Japanese that has hundreds or thousands of characters, then you really
can't fit them into a mere 256, so they had to forget about <FONT SIZE="-1">ASCII</FONT>
altogether, and build their own systems using pairs of numbers to refer
to one character.
<P>

To fix this, some people formed Unicode, Inc. and
produced a new character set containing all the characters you can
possibly think of and more. There are several ways of representing these
characters, and the one Perl uses is called <FONT SIZE="-1">UTF-8</FONT>. <FONT SIZE="-1">UTF-8</FONT> uses
a variable number of bytes to represent a character, instead of just
one. You can learn more about Unicode at <A HREF="http://www.unicode.org/">http://www.unicode.org/</A>
<A NAME="lbCC">&nbsp;</A>
<H2>How can I recognise a <FONT SIZE="-1">UTF-8</FONT> string?</H2>

<A NAME="ixADR"></A>
You can't. This is because <FONT SIZE="-1">UTF-8</FONT> data is stored in bytes just like
non-UTF-8 data. The Unicode character 200, (<TT>0xC8</TT> for you hex types)
capital E with a grave accent, is represented by the two bytes
<TT>&quot;v196.172&quot;</TT>. Unfortunately, the non-Unicode string <TT>&quot;chr(196).chr(172)&quot;</TT>
has that byte sequence as well. So you can't tell just by looking - this
is what makes Unicode input an interesting problem.
<P>

The <FONT SIZE="-1">API</FONT> function <TT>&quot;is_utf8_string&quot;</TT> can help; it'll tell you if a string
contains only valid <FONT SIZE="-1">UTF-8</FONT> characters. However, it can't do the work for
you. On a character-by-character basis, <TT>&quot;is_utf8_char&quot;</TT> will tell you
whether the current character in a string is valid <FONT SIZE="-1">UTF-8</FONT>.
<A NAME="lbCD">&nbsp;</A>
<H2>How does <FONT SIZE="-1">UTF-8</FONT> represent Unicode characters?</H2>

<A NAME="ixADS"></A>
As mentioned above, <FONT SIZE="-1">UTF-8</FONT> uses a variable number of bytes to store a
character. Characters with values 1...128 are stored in one byte, just
like good ol' <FONT SIZE="-1">ASCII</FONT>. Character 129 is stored as <TT>&quot;v194.129&quot;</TT>; this
continues up to character 191, which is <TT>&quot;v194.191&quot;</TT>. Now we've run out of
bits (191 is binary <TT>10111111</TT>) so we move on; 192 is <TT>&quot;v195.128&quot;</TT>. And
so it goes on, moving to three bytes at character 2048.
<P>

Assuming you know you're dealing with a <FONT SIZE="-1">UTF-8</FONT> string, you can find out
how long the first character in it is with the <TT>&quot;UTF8SKIP&quot;</TT> macro:
<P>



<PRE>
    char *utf = &quot;\305\233\340\240\201&quot;;
    I32 len;

</PRE>


<P>



<PRE>
    len = UTF8SKIP(utf); /* len is 2 here */
    utf += len;
    len = UTF8SKIP(utf); /* len is 3 here */

</PRE>


<P>

Another way to skip over characters in a <FONT SIZE="-1">UTF-8</FONT> string is to use
<TT>&quot;utf8_hop&quot;</TT>, which takes a string and a number of characters to skip
over. You're on your own about bounds checking, though, so don't use it
lightly.
<P>

All bytes in a multi-byte <FONT SIZE="-1">UTF-8</FONT> character will have the high bit set,
so you can test if you need to do something special with this
character like this (the <FONT SIZE="-1"><I>UTF8_IS_INVARIANT</I></FONT><I>()</I> is a macro that tests
whether the byte can be encoded as a single byte even in <FONT SIZE="-1">UTF-8</FONT>):
<P>



<PRE>
    U8 *utf;
    UV uv;      /* Note: a UV, not a U8, not a char */

</PRE>


<P>



<PRE>
    if (!UTF8_IS_INVARIANT(*utf))
        /* Must treat this as UTF-8 */
        uv = utf8_to_uv(utf);
    else
        /* OK to treat this character as a byte */
        uv = *utf;

</PRE>


<P>

You can also see in that example that we use <TT>&quot;utf8_to_uv&quot;</TT> to get the
value of the character; the inverse function <TT>&quot;uv_to_utf8&quot;</TT> is available
for putting a <FONT SIZE="-1">UV</FONT> into <FONT SIZE="-1">UTF-8:</FONT>
<P>



<PRE>
    if (!UTF8_IS_INVARIANT(uv))
        /* Must treat this as UTF8 */
        utf8 = uv_to_utf8(utf8, uv);
    else
        /* OK to treat this character as a byte */
        *utf8++ = uv;

</PRE>


<P>

You <B>must</B> convert characters to UVs using the above functions if
you're ever in a situation where you have to match <FONT SIZE="-1">UTF-8</FONT> and non-UTF-8
characters. You may not skip over <FONT SIZE="-1">UTF-8</FONT> characters in this case. If you
do this, you'll lose the ability to match hi-bit non-UTF-8 characters;
for instance, if your <FONT SIZE="-1">UTF-8</FONT> string contains <TT>&quot;v196.172&quot;</TT>, and you skip
that character, you can never match a <TT>&quot;chr(200)&quot;</TT> in a non-UTF-8 string.
So don't do that!
<A NAME="lbCE">&nbsp;</A>
<H2>How does Perl store <FONT SIZE="-1">UTF-8</FONT> strings?</H2>

<A NAME="ixADT"></A>
Currently, Perl deals with Unicode strings and non-Unicode strings
slightly differently. If a string has been identified as being <FONT SIZE="-1">UTF-8</FONT>
encoded, Perl will set a flag in the <FONT SIZE="-1">SV</FONT>, <TT>&quot;SVf_UTF8&quot;</TT>. You can check and
manipulate this flag with the following macros:
<P>



<PRE>
    SvUTF8(sv)
    SvUTF8_on(sv)
    SvUTF8_off(sv)

</PRE>


<P>

This flag has an important effect on Perl's treatment of the string: if
Unicode data is not properly distinguished, regular expressions,
<TT>&quot;length&quot;</TT>, <TT>&quot;substr&quot;</TT> and other string handling operations will have
undesirable results.
<P>

The problem comes when you have, for instance, a string that isn't
flagged is <FONT SIZE="-1">UTF-8</FONT>, and contains a byte sequence that could be <FONT SIZE="-1">UTF-8</FONT> -
especially when combining non-UTF-8 and <FONT SIZE="-1">UTF-8</FONT> strings.
<P>

Never forget that the <TT>&quot;SVf_UTF8&quot;</TT> flag is separate to the <FONT SIZE="-1">PV</FONT> value; you
need be sure you don't accidentally knock it off while you're
manipulating SVs. More specifically, you cannot expect to do this:
<P>



<PRE>
    SV *sv;
    SV *nsv;
    STRLEN len;
    char *p;

</PRE>


<P>



<PRE>
    p = SvPV(sv, len);
    frobnicate(p);
    nsv = newSVpvn(p, len);

</PRE>


<P>

The <TT>&quot;char*&quot;</TT> string does not tell you the whole story, and you can't
copy or reconstruct an <FONT SIZE="-1">SV</FONT> just by copying the string value. Check if the
old <FONT SIZE="-1">SV</FONT> has the <FONT SIZE="-1">UTF-8</FONT> flag set, and act accordingly:
<P>



<PRE>
    p = SvPV(sv, len);
    frobnicate(p);
    nsv = newSVpvn(p, len);
    if (SvUTF8(sv))
        SvUTF8_on(nsv);

</PRE>


<P>

In fact, your <TT>&quot;frobnicate&quot;</TT> function should be made aware of whether or
not it's dealing with <FONT SIZE="-1">UTF-8</FONT> data, so that it can handle the string
appropriately.
<P>

Since just passing an <FONT SIZE="-1">SV</FONT> to an <FONT SIZE="-1">XS</FONT> function and copying the data of
the <FONT SIZE="-1">SV</FONT> is not enough to copy the <FONT SIZE="-1">UTF-8</FONT> flags, even less right is just
passing a <TT>&quot;char *&quot;</TT> to an <FONT SIZE="-1">XS</FONT> function.
<A NAME="lbCF">&nbsp;</A>
<H2>How do I convert a string to <FONT SIZE="-1">UTF-8</FONT>?</H2>

<A NAME="ixADU"></A>
If you're mixing <FONT SIZE="-1">UTF-8</FONT> and non-UTF-8 strings, you might find it necessary
to upgrade one of the strings to <FONT SIZE="-1">UTF-8</FONT>. If you've got an <FONT SIZE="-1">SV</FONT>, the easiest
way to do this is:
<P>



<PRE>
    sv_utf8_upgrade(sv);

</PRE>


<P>

However, you must not do this, for example:
<P>



<PRE>
    if (!SvUTF8(left))
        sv_utf8_upgrade(left);

</PRE>


<P>

If you do this in a binary operator, you will actually change one of the
strings that came into the operator, and, while it shouldn't be noticeable
by the end user, it can cause problems.
<P>

Instead, <TT>&quot;bytes_to_utf8&quot;</TT> will give you a UTF-8-encoded <B>copy</B> of its
string argument. This is useful for having the data available for
comparisons and so on, without harming the original <FONT SIZE="-1">SV</FONT>. There's also
<TT>&quot;utf8_to_bytes&quot;</TT> to go the other way, but naturally, this will fail if
the string contains any characters above 255 that can't be represented
in a single byte.
<A NAME="lbCG">&nbsp;</A>
<H2>Is there anything else I need to know?

</H2>

<A NAME="ixADV"></A>
Not really. Just remember these things:
<DL COMPACT>
<DT>*<DD>
There's no way to tell if a string is <FONT SIZE="-1">UTF-8</FONT> or not. You can tell if an <FONT SIZE="-1">SV</FONT>
is <FONT SIZE="-1">UTF-8</FONT> by looking at is <TT>&quot;SvUTF8&quot;</TT> flag. Don't forget to set the flag if
something should be <FONT SIZE="-1">UTF-8</FONT>. Treat the flag as part of the <FONT SIZE="-1">PV</FONT>, even though
it's not - if you pass on the <FONT SIZE="-1">PV</FONT> to somewhere, pass on the flag too.
<DT>*<DD>
If a string is <FONT SIZE="-1">UTF-8</FONT>, <B>always</B> use <TT>&quot;utf8_to_uv&quot;</TT> to get at the value,
unless <TT>&quot;UTF8_IS_INVARIANT(*s)&quot;</TT> in which case you can use <TT>*s</TT>.
<DT>*<DD>
When writing a character <TT>&quot;uv&quot;</TT> to a <FONT SIZE="-1">UTF-8</FONT> string, <B>always</B> use
<TT>&quot;uv_to_utf8&quot;</TT>, unless <TT>&quot;UTF8_IS_INVARIANT(uv))&quot;</TT> in which case
you can use <TT>&quot;*s = uv&quot;</TT>.
<DT>*<DD>
Mixing <FONT SIZE="-1">UTF-8</FONT> and non-UTF-8 strings is tricky. Use <TT>&quot;bytes_to_utf8&quot;</TT> to get
a new string which is <FONT SIZE="-1">UTF-8</FONT> encoded. There are tricks you can use to
delay deciding whether you need to use a <FONT SIZE="-1">UTF-8</FONT> string until you get to a
high character - <TT>&quot;HALF_UPGRADE&quot;</TT> is one of those.
</DL>
<A NAME="lbCH">&nbsp;</A>
<H2>Custom Operators</H2>

<A NAME="ixADW"></A>
Custom operator support is a new experimental feature that allows you to
define your own ops. This is primarily to allow the building of
interpreters for other languages in the Perl core, but it also allows
optimizations through the creation of ``macro-ops'' (ops which perform the
functions of multiple ops which are usually executed together, such as
<TT>&quot;gvsv, gvsv, add&quot;</TT>.) 
<P>

This feature is implemented as a new op type, <TT>&quot;OP_CUSTOM&quot;</TT>. The Perl
core does not ``know'' anything special about this op type, and so it will
not be involved in any optimizations. This also means that you can
define your custom ops to be any op structure - unary, binary, list and
so on - you like.
<P>

It's important to know what custom operators won't do for you. They
won't let you add new syntax to Perl, directly. They won't even let you
add new keywords, directly. In fact, they won't change the way Perl
compiles a program at all. You have to do those changes yourself, after
Perl has compiled the program. You do this either by manipulating the op
tree using a <TT>&quot;CHECK&quot;</TT> block and the <TT>&quot;B::Generate&quot;</TT> module, or by adding
a custom peephole optimizer with the <TT>&quot;optimize&quot;</TT> module.
<P>

When you do this, you replace ordinary Perl ops with custom ops by
creating ops with the type <TT>&quot;OP_CUSTOM&quot;</TT> and the <TT>&quot;pp_addr&quot;</TT> of your own
<FONT SIZE="-1">PP</FONT> function. This should be defined in <FONT SIZE="-1">XS</FONT> code, and should look like
the <FONT SIZE="-1">PP</FONT> ops in <TT>&quot;pp_*.c&quot;</TT>. You are responsible for ensuring that your op
takes the appropriate number of values from the stack, and you are
responsible for adding stack marks if necessary.
<P>

You should also ``register'' your op with the Perl interpreter so that it
can produce sensible error and warning messages. Since it is possible to
have multiple custom ops within the one ``logical'' op type <TT>&quot;OP_CUSTOM&quot;</TT>,
Perl uses the value of <TT>&quot;o-&gt;op_ppaddr&quot;</TT> as a key into the
<TT>&quot;PL_custom_op_descs&quot;</TT> and <TT>&quot;PL_custom_op_names&quot;</TT> hashes. This means you
need to enter a name and description for your op at the appropriate
place in the <TT>&quot;PL_custom_op_names&quot;</TT> and <TT>&quot;PL_custom_op_descs&quot;</TT> hashes.
<P>

Forthcoming versions of <TT>&quot;B::Generate&quot;</TT> (version 1.0 and above) should
directly support the creation of custom ops by name; <TT>&quot;Opcodes::Custom&quot;</TT> 
will provide functions which make it trivial to ``register'' custom ops to
the Perl interpreter.
<A NAME="lbCI">&nbsp;</A>
<H2>AUTHORS</H2>

<A NAME="ixADX"></A>
Until May 1997, this document was maintained by Jeff Okamoto
&lt;<A HREF="mailto:okamoto@corp.hp.com">okamoto@corp.hp.com</A>&gt;.  It is now maintained as part of Perl
itself by the Perl 5 Porters &lt;<A HREF="mailto:perl5-porters@perl.org">perl5-porters@perl.org</A>&gt;.
<P>

With lots of help and suggestions from Dean Roehrich, Malcolm Beattie,
Andreas Koenig, Paul Hudson, Ilya Zakharevich, Paul Marquess, Neil
Bowers, Matthew Green, Tim Bunce, Spider Boardman, Ulrich Pfeifer,
Stephen McCamant, and Gurusamy Sarathy.
<A NAME="lbCJ">&nbsp;</A>
<H2>SEE ALSO</H2>

<A NAME="ixADY"></A>
<I><A HREF="../man1/perlapi.1.php">perlapi</A></I>(1), <I><A HREF="../man1/perlintern.1.php">perlintern</A></I>(1), <I><A HREF="../man1/perlxs.1.php">perlxs</A></I>(1), <I><A HREF="../man1/perlembed.1.php">perlembed</A></I>(1)
<P>

<HR>
<A NAME="index">&nbsp;</A><H2>Index</H2>
<DL>
<DT><A HREF="#lbAB">NAME</A><DD>
<DT><A HREF="#lbAC">DESCRIPTION</A><DD>
<DT><A HREF="#lbAD">Variables</A><DD>
<DT><A HREF="#lbAE">Datatypes</A><DD>
<DT><A HREF="#lbAF">What is an <FONT SIZE="-1">IV</FONT>?</A><DD>
<DT><A HREF="#lbAG">Working with SVs</A><DD>
<DT><A HREF="#lbAH">Offsets</A><DD>
<DT><A HREF="#lbAI">What's Really Stored in an <FONT SIZE="-1">SV</FONT>?</A><DD>
<DT><A HREF="#lbAJ">Working with AVs</A><DD>
<DT><A HREF="#lbAK">Working with HVs</A><DD>
<DT><A HREF="#lbAL">Hash <FONT SIZE="-1">API</FONT> Extensions</A><DD>
<DT><A HREF="#lbAM">AVs, HVs and undefined values</A><DD>
<DT><A HREF="#lbAN">References</A><DD>
<DT><A HREF="#lbAO">Blessed References and Class Objects</A><DD>
<DT><A HREF="#lbAP">Creating New Variables</A><DD>
<DT><A HREF="#lbAQ">Reference Counts and Mortality</A><DD>
<DT><A HREF="#lbAR">Stashes and Globs</A><DD>
<DT><A HREF="#lbAS">Double-Typed SVs</A><DD>
<DT><A HREF="#lbAT">Magic Variables</A><DD>
<DT><A HREF="#lbAU">Assigning Magic</A><DD>
<DT><A HREF="#lbAV">Magic Virtual Tables</A><DD>
<DT><A HREF="#lbAW">Finding Magic</A><DD>
<DT><A HREF="#lbAX">Understanding the Magic of Tied Hashes and Arrays</A><DD>
<DT><A HREF="#lbAY">Localizing changes</A><DD>
<DT><A HREF="#lbAZ">Subroutines</A><DD>
<DT><A HREF="#lbBA">XSUBs and the Argument Stack</A><DD>
<DT><A HREF="#lbBB">Calling Perl Routines from within C Programs</A><DD>
<DT><A HREF="#lbBC">Memory Allocation</A><DD>
<DT><A HREF="#lbBD">PerlIO</A><DD>
<DT><A HREF="#lbBE">Putting a C value on Perl stack</A><DD>
<DT><A HREF="#lbBF">Scratchpads</A><DD>
<DT><A HREF="#lbBG">Scratchpads and recursion</A><DD>
<DT><A HREF="#lbBH">Compiled code</A><DD>
<DT><A HREF="#lbBI">Code tree</A><DD>
<DT><A HREF="#lbBJ">Examining the tree</A><DD>
<DT><A HREF="#lbBK">Compile pass 1: check routines</A><DD>
<DT><A HREF="#lbBL">Compile pass 1a: constant folding</A><DD>
<DT><A HREF="#lbBM">Compile pass 2: context propagation</A><DD>
<DT><A HREF="#lbBN">Compile pass 3: peephole optimization</A><DD>
<DT><A HREF="#lbBO">Pluggable runops</A><DD>
<DT><A HREF="#lbBP">Examining internal data structures with the dump functions</A><DD>
<DT><A HREF="#lbBQ">How multiple interpreters and concurrency are supported</A><DD>
<DT><A HREF="#lbBR">Background and <FONT SIZE="-1">PERL_IMPLICIT_CONTEXT</FONT></A><DD>
<DT><A HREF="#lbBS">So what happened to dTHR?</A><DD>
<DT><A HREF="#lbBT">How do I use all this in extensions?</A><DD>
<DT><A HREF="#lbBU">Should I do anything special if I call perl from multiple threads?</A><DD>
<DT><A HREF="#lbBV">Future Plans and <FONT SIZE="-1">PERL_IMPLICIT_SYS</FONT></A><DD>
<DT><A HREF="#lbBW">Internal Functions</A><DD>
<DT><A HREF="#lbBX">Formatted Printing of IVs, UVs, and NVs</A><DD>
<DT><A HREF="#lbBY">Pointer-To-Integer and Integer-To-Pointer</A><DD>
<DT><A HREF="#lbBZ">Source Documentation</A><DD>
<DT><A HREF="#lbCA">Unicode Support</A><DD>
<DT><A HREF="#lbCB">What <B>is</B> Unicode, anyway?</A><DD>
<DT><A HREF="#lbCC">How can I recognise a <FONT SIZE="-1">UTF-8</FONT> string?</A><DD>
<DT><A HREF="#lbCD">How does <FONT SIZE="-1">UTF-8</FONT> represent Unicode characters?</A><DD>
<DT><A HREF="#lbCE">How does Perl store <FONT SIZE="-1">UTF-8</FONT> strings?</A><DD>
<DT><A HREF="#lbCF">How do I convert a string to <FONT SIZE="-1">UTF-8</FONT>?</A><DD>
<DT><A HREF="#lbCG">Is there anything else I need to know?</A><DD>
<DT><A HREF="#lbCH">Custom Operators</A><DD>
<DT><A HREF="#lbCI">AUTHORS</A><DD>
<DT><A HREF="#lbCJ">SEE ALSO</A><DD>
</DL>

</div>






</div>




</body>
</html>
